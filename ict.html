<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT Portal - Infrastructure & Support</title>
    <link rel="icon" href="assets/onit-logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sidebar-link { transition: all 0.3s ease; }
        .sidebar-link:hover { background-color: rgba(255,255,255,0.06); transform: translateX(4px); }
        .sidebar-link.active { background-color: rgba(255,255,255,0.08); border-left: 4px solid rgba(255,255,255,0.12); }
        .content-section { display: none; }
        .content-section.active { display: block; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Login Screen -->
    <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-cyan-600 to-cyan-900">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h1 class="text-3xl font-bold text-center mb-2">ICT Portal</h1>
            <button type="button" onclick="window.location.href='index.html'" class="text-cyan-600 hover:text-cyan-700 text-sm mb-4">‚Üê Back</button>
    
            
            <form id="ictLoginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Email</label>
                    <select id="ictUserEmail" required class="w-full p-3 border rounded focus:outline-none focus:border-cyan-500">
                        <option value="">Loading users...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold mb-2">Password</label>
                    <input type="password" id="ictUserPassword" placeholder="Password" required class="w-full p-3 border rounded focus:outline-none focus:border-cyan-500" />
                </div>
                
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-3 rounded">Login</button>
            </form>
            
                <p id="ictLoginError" class="text-center text-red-500 mt-4 hidden"></p>
        </div>
    </div>

    <!-- ICT Portal Dashboard -->
    <div id="ictPortal" class="hidden flex h-screen">
        <aside class="w-64 bg-gradient-to-b from-cyan-700 to-cyan-900 text-white p-6">
            <div class="mb-6 pb-6 border-b border-cyan-600 flex items-center gap-3">
                <img src="assets/onit-logo.png" alt="Onit MFB logo" class="w-12 h-12 object-contain">
                <div>
                    <h1 class="text-xl font-bold">Onit</h1>
                    <p class="text-xs text-cyan-200">MFB - ICT</p>
                </div>
            </div>
            
            <div class="mb-4 pb-4 border-b border-cyan-600">
                <p class="text-sm text-cyan-100">Logged in as:</p>
                <p id="ictUserDisplay" class="font-semibold">-</p>
                <p id="ictRoleDisplay" class="text-xs text-cyan-200">-</p>
            </div>

            <nav class="space-y-2">
                <button onclick="switchIctSection('dashboard')" class="sidebar-link active w-full text-left px-4 py-3 rounded">üìä Dashboard</button>
                <button onclick="switchIctSection('support')" class="sidebar-link w-full text-left px-4 py-3 rounded">üõ†Ô∏è Support Tickets</button>
                <button onclick="switchIctSection('infrastructure')" class="sidebar-link w-full text-left px-4 py-3 rounded">üñ•Ô∏è Infrastructure</button>
                <button onclick="switchIctSection('systems')" class="sidebar-link w-full text-left px-4 py-3 rounded">‚öôÔ∏è Systems</button>
                <button onclick="switchIctSection('reports')" class="sidebar-link w-full text-left px-4 py-3 rounded">üìà Reports</button>
                <button onclick="switchIctSection('leave')" class="sidebar-link w-full text-left px-4 py-3 rounded">üèñÔ∏è Leave</button>
                <button onclick="switchIctSection('finance')" class="sidebar-link w-full text-left px-4 py-3 rounded">üí∞ Finance</button>
                <button onclick="switchIctSection('tickets')" class="sidebar-link w-full text-left px-4 py-3 rounded">üé´ Tickets</button>
            </nav>
            <div class="mt-8 pt-8 border-t border-cyan-600">
                <button onclick="ictLogout()" class="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded">üö™ Logout</button>
            </div>
        </aside>

        <main class="flex-1 overflow-auto">
            <!-- Dashboard -->
            <div id="dashboard" class="content-section active p-8">
                <h2 class="text-3xl font-bold mb-6">ICT Dashboard</h2>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <!-- Open Tickets Card -->
                    <div class="bg-white rounded-lg shadow-md p-6 border-t-4 border-blue-500 hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Open Tickets</p>
                                <p class="text-3xl font-bold text-blue-600 mt-2" id="dashboardOpenTicketsIct">0</p>
                            </div>
                            <div class="text-5xl text-blue-200">üé´</div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">Support: <span class="font-semibold text-blue-600" id="openCount">0</span></p>
                    </div>

                    <!-- System Uptime Card -->
                    <div class="bg-white rounded-lg shadow-md p-6 border-t-4 border-green-500 hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">System Uptime</p>
                                <p class="text-3xl font-bold text-green-600 mt-2" id="dashboardUptimeIct">99.9%</p>
                            </div>
                            <div class="text-5xl text-green-200">üü¢</div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">Status: <span class="font-semibold text-green-600" id="uptimeStatus">Excellent</span></p>
                    </div>

                    <!-- My Leave Balance Card -->
                    <div class="bg-white rounded-lg shadow-md p-6 border-t-4 border-purple-500 hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">My Leave Balance</p>
                                <p class="text-3xl font-bold text-purple-600 mt-2" id="dashboardLeaveIct">0</p>
                            </div>
                            <div class="text-5xl text-purple-200">üèñÔ∏è</div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">Days: <span class="font-semibold text-purple-600" id="leaveCount">0</span></p>
                    </div>

                    <!-- Claims Status Card -->
                    <div class="bg-white rounded-lg shadow-md p-6 border-t-4 border-orange-500 hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">My Claims</p>
                                <p class="text-3xl font-bold text-orange-600 mt-2" id="dashboardClaimsIct">0</p>
                            </div>
                            <div class="text-5xl text-orange-200">üíº</div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">Pending: <span class="font-semibold text-orange-600" id="claimsCount">0</span></p>
                    </div>
                </div>

                <!-- Leave Balances -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Leave Balance - Your Account</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <p class="text-gray-600 text-sm font-semibold">Annual Leave</p>
                            <p class="text-3xl font-bold text-blue-600 mt-2" id="balAnnual">0</p>
                            <p class="text-xs text-gray-500 mt-1">days remaining</p>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg border border-red-200">
                            <p class="text-gray-600 text-sm font-semibold">Sick Leave</p>
                            <p class="text-3xl font-bold text-red-600 mt-2" id="balSick">0</p>
                            <p class="text-xs text-gray-500 mt-1">days remaining</p>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <p class="text-gray-600 text-sm font-semibold">Personal Leave</p>
                            <p class="text-3xl font-bold text-yellow-600 mt-2" id="balPersonal">0</p>
                            <p class="text-xs text-gray-500 mt-1">days remaining</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Support Tickets -->
            <div id="support" class="content-section p-8">
                <h2 class="text-2xl font-bold mb-6">Support Tickets</h2>
                <button onclick="showNewTicketForm()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded mb-4">‚ûï New Ticket</button>
                <div class="bg-white rounded shadow">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-left">Ticket ID</th>
                                <th class="p-3 text-left">Issue</th>
                                <th class="p-3 text-left">Priority</th>
                                <th class="p-3 text-left">Status</th>
                                <th class="p-3 text-left">Assigned To</th>
                                <th class="p-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="supportTicketsList">
                            <tr><td class="p-4 text-center" colspan="6">No tickets</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Infrastructure -->
            <div id="infrastructure" class="content-section p-8">
                <h2 class="text-2xl font-bold mb-6">Infrastructure Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="text-xl font-semibold mb-4">Servers</h3>
                        <div id="serversList" class="space-y-3">
                            <p class="text-gray-500">No servers configured</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="text-xl font-semibold mb-4">Network Status</h3>
                        <div id="networkStatus" class="space-y-3">
                            <p class="text-green-600">‚úì All systems operational</p>
                        </div>
                    </div>
                </div>

                <!-- Asset Register -->
                <div class="mt-6 bg-white p-6 rounded shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Asset Register</h3>
                        <div class="flex gap-2">
                            <button id="exportAssetsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded text-sm">Export</button>
                            <button id="toggleNewAssetBtn" class="bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1 rounded text-sm">+ New Asset</button>
                        </div>
                    </div>

                    <form id="newAssetForm" class="space-y-3 mb-4 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-sm font-medium">Asset Tag</label>
                                <input id="assetTag" class="w-full p-2 border rounded mt-1" placeholder="TAG-001" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Name</label>
                                <input id="assetName" class="w-full p-2 border rounded mt-1" placeholder="Dell Laptop" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Category</label>
                                <input id="assetCategory" class="w-full p-2 border rounded mt-1" placeholder="Laptop / Router / Server" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-sm font-medium">Location</label>
                                <input id="assetLocation" class="w-full p-2 border rounded mt-1" placeholder="Head Office" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Status</label>
                                <select id="assetStatus" class="w-full p-2 border rounded mt-1">
                                    <option value="In Use">In Use</option>
                                    <option value="In Stock">In Stock</option>
                                    <option value="Under Repair">Under Repair</option>
                                    <option value="Retired">Retired</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Purchase Date</label>
                                <input id="assetPurchaseDate" type="date" class="w-full p-2 border rounded mt-1" />
                            </div>
                        </div>
                        <div class="flex justify-end gap-2">
                            <button type="submit" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded">Add Asset</button>
                            <button type="button" id="cancelNewAssetBtn" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">Cancel</button>
                        </div>
                    </form>

                    <div class="overflow-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-left">Tag</th>
                                    <th class="p-3 text-left">Name</th>
                                    <th class="p-3 text-left">Category</th>
                                    <th class="p-3 text-left">Location</th>
                                    <th class="p-3 text-left">Status</th>
                                    <th class="p-3 text-left">Purchased</th>
                                    <th class="p-3 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assetListBody">
                                <tr><td class="p-4 text-center" colspan="7">No assets registered</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Systems -->
            <div id="systems" class="content-section p-8">
                <h2 class="text-2xl font-bold mb-6">System Administration</h2>
                <div class="bg-white rounded shadow p-6">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 border-b">
                            <span class="font-semibold">Database Backups</span>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">Backup Now</button>
                        </div>
                        <div class="flex justify-between items-center p-3 border-b">
                            <span class="font-semibold">Security Updates</span>
                            <span class="text-green-600">‚úì Up to Date</span>
                        </div>
                        <div class="flex justify-between items-center p-3 border-b">
                            <span class="font-semibold">System Logs</span>
                            <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">View Logs</button>
                        </div>
                        <div class="flex justify-between items-center p-3">
                            <span class="font-semibold">Performance Metrics</span>
                            <button class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">Monitor</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports -->
            <div id="reports" class="content-section p-8">
                <h2 class="text-2xl font-bold mb-6">Reports</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-semibold mb-2">Monthly Uptime</h3>
                        <p class="text-2xl font-bold text-green-600">99.8%</p>
                    </div>
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-semibold mb-2">Tickets Resolved</h3>
                        <p class="text-2xl font-bold text-blue-600">45</p>
                    </div>
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-semibold mb-2">Avg Response Time</h3>
                        <p class="text-2xl font-bold text-orange-600">2.5 hrs</p>
                    </div>
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-semibold mb-2">Critical Issues</h3>
                        <p class="text-2xl font-bold text-red-600">0</p>
                    </div>
                </div>
            </div>

            <!-- Leave Management -->
            <div id="leave" class="content-section p-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Leave Management</h2>
                    <button onclick="showNewLeaveForm()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1 rounded">+ Request Leave</button>
                </div>
                <div id="newLeaveForm" class="hidden card mb-4">
                    <form id="leaveFormEl" class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Name</label>
                                <input id="leaveName" type="text" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Email</label>
                                <input id="leaveEmail" type="email" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Leave Type</label>
                                <select id="leaveType" required class="p-2 border rounded w-full mt-1"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Personal">Personal</option></select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Start Date</label>
                                <input id="leaveStartDate" type="date" required class="w-full p-2 border rounded mt-1" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">End Date</label>
                                <input id="leaveEndDate" type="date" required class="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Days</label>
                                <input id="leaveDays" type="number" min="0" required class="w-full input mt-1" placeholder="Calculated automatically" readonly />
                                <p class="text-xs text-gray-500 mt-1">Excludes weekends and public holidays.</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Resume Work On</label>
                                <input id="leaveResumeDate" type="date" required class="w-full p-2 border rounded mt-1" />
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">Reason (optional)</label>
                            <textarea id="leaveReason" rows="3" class="w-full p-2 border rounded mt-1" placeholder="Reason for leave"></textarea>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded" type="submit">Submit Request</button>
                            <button type="button" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" onclick="hideNewLeaveForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded shadow p-4">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-orange-600 to-orange-800 text-white"><tr><th class="p-3 text-left font-bold">üìã ID</th><th class="p-3 text-left font-bold">üë§ Name</th><th class="p-3 text-left font-bold">üìß Email</th><th class="p-3 text-left font-bold">üèñÔ∏è Type</th><th class="p-3 text-left font-bold">üìÖ Start Date</th><th class="p-3 text-left font-bold">üìÖ End Date</th><th class="p-3 text-left font-bold">üìÖ Resume Date</th><th class="p-3 text-left font-bold">‚è±Ô∏è Days</th><th class="p-3 text-left font-bold">‚úì Status</th></tr></thead>
                        <tbody id="leaveList"><tr><td class="p-4 text-center" colspan="9">No leave requests</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Expense Claims -->
            <div id="finance" class="content-section p-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Finance - Expense Claims</h2>
                    <button onclick="showNewClaimForm()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1 rounded">+ New Claim</button>
                </div>
                <div id="newClaimForm" class="hidden card mb-4">
                    <h3 class="font-semibold mb-4">Submit Expense Claim</h3>
                    <form id="claimFormEl" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Name</label>
                                <input id="claimName" type="text" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Email</label>
                                <input id="claimEmail" type="email" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Expense Type</label>
                                <select id="claimType" required class="p-2 border rounded w-full mt-1"><option value="Travel">Travel</option><option value="Meals">Meals</option><option value="Supplies">Supplies</option><option value="Other">Other</option></select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Amount</label>
                                <input id="claimAmount" type="number" min="0" step="0.01" required class="w-full p-2 border rounded mt-1" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Date</label>
                                <input id="claimDate" type="date" required class="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Receipt (optional)</label>
                                <input id="claimReceipt" type="file" class="w-full mt-1" />
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">Description (optional)</label>
                            <textarea id="claimDescription" rows="3" class="w-full p-2 border rounded mt-1" placeholder="Details about the expense"></textarea>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded" type="submit">Submit Claim</button>
                            <button type="button" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" onclick="hideNewClaimForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded shadow p-4">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-blue-600 to-blue-800 text-white"><tr><th class="p-3 text-left font-bold">üìã ID</th><th class="p-3 text-left font-bold">üë§ Name</th><th class="p-3 text-left font-bold">üìß Email</th><th class="p-3 text-left font-bold">üí∞ Type</th><th class="p-3 text-left font-bold">üíµ Amount</th><th class="p-3 text-left font-bold">üìÖ Date</th><th class="p-3 text-left font-bold">‚úì Status</th></tr></thead>
                        <tbody id="claimsList"><tr><td class="p-4 text-center" colspan="7">No claims</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- General Tickets -->
            <div id="tickets" class="content-section p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">System Tickets</h2>
                    <button type="button" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded" onclick="document.getElementById('newIctTicketForm').classList.toggle('hidden')">+ New Ticket</button>
                </div>
                <div id="newIctTicketForm" class="bg-white rounded shadow p-4 mb-4 hidden">
                    <h3 class="font-semibold mb-4">Submit New Ticket</h3>
                    <form id="ictTicketFormEl" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Subject</label>
                                <input id="ictTicketSubject" placeholder="Short title" required class="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Type</label>
                                <select id="ictTicketType" class="w-full p-2 border rounded mt-1">
                                    <option value="Request">Request</option>
                                    <option value="Issue">Issue</option>
                                    <option value="Bug">Bug</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Department</label>
                                <select id="ictTicketDepartment" class="w-full p-2 border rounded mt-1">
                                    <option value="Branch">Branch</option>
                                    <option value="ICT">ICT</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Submitting For</label>
                                <select id="ictTicketSubmittingFor" class="w-full p-2 border rounded mt-1">
                                    <option value="">Select type</option>
                                    <option value="Customer">Customer</option>
                                    <option value="User">User</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">Description</label>
                            <textarea id="ictTicketDescription" placeholder="What happened? Provide steps or context." required class="w-full p-2 border rounded mt-1" rows="4"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
                            <div>
                                <label class="text-sm font-medium">Priority</label>
                                <select id="ictTicketPriority" class="w-full input mt-1">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Due Date (optional)</label>
                                <input id="ictTicketDueDate" type="date" class="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Attachment (optional)</label>
                                <input id="ictTicketAttachment" type="file" class="w-full mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Created Date</label>
                                <input id="ictTicketCreatedDate" type="date" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded" type="submit">Submit Ticket</button>
                            <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded" onclick="document.getElementById('newIctTicketForm').classList.add('hidden')">Cancel</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white rounded shadow p-4">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-left">ID</th>
                                <th class="p-3 text-left">Subject</th>
                                <th class="p-3 text-left">Status</th>
                                <th class="p-3 text-left">Priority</th>
                                <th class="p-3 text-left">Date</th>
                            </tr>
                        </thead>
                        <tbody id="ictTicketsList">
                            <tr><td class="p-4 text-center" colspan="5">No tickets</td></tr>
                        </tbody>
                    </table>
                                <tr><td class="p-4 text-center" colspan="7">No tickets</td></tr>
            </div>
        </main>
    </div>

    <script>
        // populateIctUsers() is defined later and will be called after demo users exist
        // Login handler - authenticate against backend
        document.getElementById('ictLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            (async ()=>{
                try {
                    const email = document.getElementById('ictUserEmail').value;
                    const password = document.getElementById('ictUserPassword').value;

                    if (!email || !password) {
                        document.getElementById('ictLoginError').textContent = 'Please fill in all fields';
                        document.getElementById('ictLoginError').classList.remove('hidden');
                        return;
                    }

                    const resp = await fetch('/api/auth', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
                    const data = await resp.json();
                    if (!data || !data.success) {
                        document.getElementById('ictLoginError').textContent = (data && data.message) ? data.message : 'Invalid credentials';
                        document.getElementById('ictLoginError').classList.remove('hidden');
                        return;
                    }

                    const user = data.user;
                    const displayName = user.full_name || user.name || user.username || user.email;
                    localStorage.setItem('ictUserName', displayName);
                    localStorage.setItem('ictUserEmail', user.email);
                    localStorage.setItem('ictUserRole', user.role || '');
                    localStorage.setItem('userDept', user.department || 'ICT');

                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('ictPortal').classList.remove('hidden');
                    document.getElementById('ictUserDisplay').textContent = displayName;
                    document.getElementById('ictRoleDisplay').textContent = user.role || user.department || 'ICT';

                    try { loadIctDashboard(); } catch(_) { console.warn('loadIctDashboard failed'); }
                    try { loadAssets(); } catch(_) { console.warn('loadAssets failed'); }
                } catch(err) {
                    console.error('ICT login error', err);
                    document.getElementById('ictLoginError').textContent = 'Login error';
                    document.getElementById('ictLoginError').classList.remove('hidden');
                }
            })();
        });

        function switchIctSection(section) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));

            // Show selected section
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            
                // Load data for specific sections
                if (section === 'dashboard') loadIctDashboard();
                else if (section === 'leave') loadLeaveRequests();
            else if (section === 'finance') loadClaims();
                else if (section === 'tickets') loadIctTickets();
        }

        function loadIctDashboard() {
                // Get user data
                const userEmail = localStorage.getItem('ictUserEmail') || '';
            
                // Get employees and find current user's leave balance
                const employees = JSON.parse(localStorage.getItem('employees') || '[]');
                const currentUser = employees.find(e => e.email === userEmail);
                const leaveBalance = currentUser?.leaveBalances || { Annual: 0, Sick: 0, Personal: 0 };
                const totalLeave = leaveBalance.Annual + leaveBalance.Sick + leaveBalance.Personal;
            
                // Get tickets
                const ictTickets = JSON.parse(localStorage.getItem('ictTickets') || '[]');
                const userTickets = ictTickets.filter(t => t.email === userEmail);
                const openTickets = userTickets.filter(t => t.status !== 'Closed').length;
            
                // Ticket priorities
                const allTickets = JSON.parse(localStorage.getItem('branchTickets') || '[]').concat(
                    JSON.parse(localStorage.getItem('financeTickets') || '[]')).concat(ictTickets);
                const highPriority = allTickets.filter(t => t.priority === 'High' && t.status !== 'Closed').length;
                const mediumPriority = allTickets.filter(t => t.priority === 'Medium' && t.status !== 'Closed').length;
                const lowPriority = allTickets.filter(t => t.priority === 'Low' && t.status !== 'Closed').length;
                const resolvedToday = allTickets.filter(t => t.status === 'Closed' && 
                    new Date(t.date).toDateString() === new Date().toDateString()).length;
            
                // Get claims
                const claims = JSON.parse(localStorage.getItem('claims') || '[]');
                const userClaims = claims.filter(c => c.email === userEmail);
                const pendingClaims = userClaims.filter(c => c.status === 'Pending').length;
            
                // Update top stats
                document.getElementById('dashboardOpenTicketsIct').textContent = openTickets;
                document.getElementById('dashboardUptimeIct').textContent = '99.9%';
                document.getElementById('dashboardLeaveIct').textContent = Math.max(totalLeave, 0);
                document.getElementById('dashboardClaimsIct').textContent = pendingClaims;
            
                // Update support status
                document.getElementById('dashboardHighPriority').textContent = highPriority;
                document.getElementById('dashboardMediumPriority').textContent = mediumPriority;
                document.getElementById('dashboardLowPriority').textContent = lowPriority;
                document.getElementById('dashboardResolvedToday').textContent = resolvedToday;
            
                // Recent activity
                const activities = [];
                userTickets.slice(-3).reverse().forEach(t => {
                    activities.push(`üé´ Ticket #${t.id}: ${t.issue} - ${t.status}`);
                });
                userClaims.slice(-2).reverse().forEach(c => {
                    activities.push(`üíº Claim: KSH ${parseFloat(c.amount).toLocaleString('en-KE', {minimumFractionDigits: 2})} - ${c.status}`);
                });
            
                const activityDiv = document.getElementById('dashboardIctActivity');
                if (activities.length > 0) {
                    activityDiv.innerHTML = activities.map(a => `<p class="text-sm text-gray-700 p-2 bg-gray-50 rounded">${a}</p>`).join('');
                } else {
                    activityDiv.innerHTML = '<p class="text-gray-500 text-center py-6">No recent activity</p>';
                }
        }

        function showNewTicketForm() {
            alert('New Ticket form would open here');
        }

            function loadIctTickets() {
                const allTickets = JSON.parse(localStorage.getItem('tickets') || '[]');
                const ictTickets = allTickets.filter(t => (t.department || '').toLowerCase() === 'ict');
                const tbody = document.getElementById('ictTicketsList');
            
                if (!tbody) return;
            
                if (ictTickets.length === 0) {
                    tbody.innerHTML = '<tr><td class="p-4 text-center" colspan="7">No tickets assigned</td></tr>';
                    return;
                }
            
                tbody.innerHTML = ictTickets.map(t => `
                    <tr class="hover:bg-gray-50">
                        <td class="p-3">${t.id}</td>
                        <td class="p-3">${t.subject || t.issue || ''}</td>
                        <td class="p-3">${t.type || ''}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs font-semibold ${t.priority === 'High' ? 'bg-red-100 text-red-800' : t.priority === 'Critical' ? 'bg-red-200 text-red-900' : 'bg-gray-100 text-gray-800'}">${t.priority || 'Low'}</span></td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs font-semibold ${t.status === 'Open' ? 'bg-yellow-100 text-yellow-800' : t.status === 'Closed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${t.status}</span></td>
                        <td class="p-3">${t.createdDate || (t.timestamp ? t.timestamp.split('T')[0] : '')}</td>
                        <td class="p-3">
                            <div class="flex items-center gap-2">
                                <button onclick="viewIctTicketDetails('${t.id}')" class="text-blue-600 hover:underline text-sm">View</button>
                                <button onclick="ictTicketAction('${t.id}','resolve')" class="text-yellow-600 hover:underline text-sm">Resolve</button>
                                <button onclick="ictTicketAction('${t.id}','close')" class="text-green-600 hover:underline text-sm">Close</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            function viewIctTicketDetails(ticketId) {
                const tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
                const t = tickets.find(x => x.id === ticketId);
                if (!t) { alert('Ticket not found'); return; }

                let modal = document.getElementById('ictTicketModal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'ictTicketModal';
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div class="sticky top-0 bg-gray-800 text-white p-6 flex justify-between items-center">
                                <h2 class="text-2xl font-bold">Ticket Details</h2>
                                <button onclick="document.getElementById('ictTicketModal').style.display='none'" class="text-2xl hover:text-gray-300">√ó</button>
                            </div>
                            <div id="ictTicketContent" class="p-6"></div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }

                document.getElementById('ictTicketContent').innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-500 text-sm">Ticket ID</p>
                                <p class="text-xl font-bold text-gray-800">${t.id}</p>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm">Status</p>
                                <p class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${t.status === 'Open' ? 'bg-yellow-100 text-yellow-800' : t.status === 'Closed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${t.status}</p>
                            </div>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Subject</p>
                            <p class="text-lg font-semibold text-gray-800">${t.subject || 'N/A'}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-500 text-sm">Priority</p>
                                <p class="inline-block px-3 py-1 rounded text-sm font-semibold ${t.priority === 'High' ? 'bg-red-100 text-red-800' : t.priority === 'Critical' ? 'bg-red-200 text-red-900' : 'bg-gray-100 text-gray-800'}">${t.priority || 'Low'}</p>
                            </div>
                            <div>
                                <p class="text-gray-500 text-sm">Created Date</p>
                                <p class="text-gray-800">${t.createdDate || (t.timestamp ? new Date(t.timestamp).toLocaleDateString() : '')}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-4 rounded border border-blue-200">
                                <p class="text-gray-500 text-sm font-semibold">Created By</p>
                                <p class="font-semibold text-gray-800">${t.created_by || t.name || 'Unknown'}</p>
                                <p class="text-sm text-gray-600">${t.created_by_email || t.email || ''}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded border border-green-200">
                                <p class="text-gray-500 text-sm font-semibold">Assigned To</p>
                                <p class="font-semibold text-gray-800">${t.assigned_to || 'Unassigned'}</p>
                            </div>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm mb-2">Description</p>
                            <div class="bg-gray-50 p-4 rounded border border-gray-200"><p class="text-gray-800 whitespace-pre-wrap">${t.description || 'No description provided'}</p></div>
                        </div>
                        ${t.resolutionNotes ? `<div><p class="text-gray-500 text-sm mb-2">Resolution Notes</p><div class="bg-yellow-50 p-4 rounded border border-yellow-200"><p class="text-gray-800 whitespace-pre-wrap">${t.resolutionNotes}</p></div></div>` : ''}
                        <div class="mt-4">
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Activity History</h3>
                            ${(t.history || []).map(h => `<div class="bg-gray-50 p-3 rounded border-l-4 border-blue-500 mb-2"><p class="font-semibold">${h.action}</p><p class="text-sm text-gray-600">By: ${h.byName || ''}</p>${h.notes ? `<p class="text-sm text-gray-700 mt-1"><strong>Notes:</strong> ${h.notes}</p>` : ''}<p class="text-xs text-gray-500 mt-1">${h.at ? new Date(h.at).toLocaleString() : ''}</p></div>`).join('')}
                        </div>
                    </div>
                `;

                modal.style.display = 'flex';
            }

            // Populate ICT users into the login select (tries API then falls back to localStorage)
            function populateIctUsers(){
                const select = document.getElementById('ictUserEmail');
                if(!select) return;
                // Immediately populate from localStorage so the UI isn't stuck on "Loading users..."
                function fallback(){
                    const ictUsers = JSON.parse(localStorage.getItem('ictUsers') || '[]');
                    if(!ictUsers || ictUsers.length===0){ select.innerHTML = '<option value="">No users</option>'; return; }
                    select.innerHTML = '<option value="">Select user...</option>' + ictUsers.map(u=>`<option value="${u.email}">${u.email}</option>`).join('');
                }
                // populate immediately from localStorage
                try{ fallback(); } catch(e){ console.warn('[ICT] fallback populate failed', e); }

                // then try API and overwrite if it returns valid data
                try{
                    const apiUrl = (window.location && window.location.protocol && window.location.protocol.startsWith('http')) ?
                        window.location.origin + '/api/users' :
                        'http://localhost:3003/api/users';
                    console.log('[ICT] fetching users from', apiUrl);
                    fetch(apiUrl).then(r=>r.json()).then(data=>{
                        if(!data || !data.success){ console.warn('[ICT] users API returned no data'); return; }
                        const usersAll = data.users || [];
                        const users = usersAll.filter(u => (u.department||'').toLowerCase() === 'ict');
                        if(users.length === 0){ console.warn('[ICT] no ICT users from API'); return; }
                        select.innerHTML = '<option value="">Select user...</option>' + users.map(u=>`<option value="${u.email}">${u.email}</option>`).join('');
                    }).catch(e=>{ console.warn('[ICT] Failed to load users from API', e); });
                }catch(e){ console.warn('[ICT] populateIctUsers error', e); }
            }

            function ictTicketAction(ticketId, action) {
                const tickets = JSON.parse(localStorage.getItem('tickets') || '[]');
                const t = tickets.find(x => x.id === ticketId);
                if (!t) { alert('Ticket not found'); return; }
                const actorId = localStorage.getItem('ictUserEmail') || localStorage.getItem('ictUserName') || 'ICT-User';
                const actorName = localStorage.getItem('ictUserName') || actorId;
                if (action === 'resolve') {
                    t.status = 'Resolved';
                    t.resolvedAt = new Date().toISOString();
                    t.resolvedBy = actorId;
                    t.resolvedByName = actorName;
                } else if (action === 'close') {
                    t.status = 'Closed';
                    t.closedAt = new Date().toISOString();
                    t.closedBy = actorId;
                    t.closedByName = actorName;
                }
                t.history = t.history || [];
                t.history.push({ action: action, by: actorId, byName: actorName, at: new Date().toISOString(), notes: '' });
                localStorage.setItem('tickets', JSON.stringify(tickets));
                loadIctTickets();
            }

        function ictLogout() {
            localStorage.removeItem('ictUserName');
            localStorage.removeItem('ictUserEmail');
            window.location.href = 'index.html';
        }

        // --- Expense Claims Functions ---
        function showNewClaimForm(){ 
            document.getElementById('claimName').value = localStorage.getItem('ictUserName')||'';
            document.getElementById('claimEmail').value = localStorage.getItem('ictUserEmail')||'';
            document.getElementById('newClaimForm').classList.remove('hidden'); 
        }
        function hideNewClaimForm(){ document.getElementById('newClaimForm').classList.add('hidden'); }

        function loadClaims(){ 
            const claims = JSON.parse(localStorage.getItem('claims')||'[]'); 
            const isAdmin = localStorage.getItem('isAdmin')==='true'; 
            const userEmail = localStorage.getItem('ictUserEmail')||localStorage.getItem('userEmail'); 
            const filtered = isAdmin?claims:claims.filter(c=>c.email===userEmail); 
            const tbody = document.getElementById('claimsList'); 
            if(filtered.length===0){ tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center">No claims</td></tr>'; return; } 
            tbody.innerHTML = filtered.map(c=>`<tr><td class="p-2">${c.id}</td><td class="p-2">${c.name||''}</td><td class="p-2">${c.email||''}</td><td class="p-2">${c.type}</td><td class="p-2">KSH ${parseFloat(c.amount).toLocaleString('en-KE', {minimumFractionDigits: 2})}</td><td class="p-2">${c.date||''}</td><td class="p-2">${c.status}</td></tr>`).join(''); 
        }

        document.getElementById('claimFormEl').addEventListener('submit', function(e){
            e.preventDefault();
            const nextIds = JSON.parse(localStorage.getItem('claimNextId') || '{"id": 1}');
            const id = String(nextIds.id);
            nextIds.id++;
            localStorage.setItem('claimNextId', JSON.stringify(nextIds));
            const type = document.getElementById('claimType').value;
            const amount = parseFloat(document.getElementById('claimAmount').value)||0;
            const date = document.getElementById('claimDate').value;
            const receiptInput = document.getElementById('claimReceipt');
            const receiptName = receiptInput && receiptInput.files && receiptInput.files[0] ? receiptInput.files[0].name : null;
            const desc = document.getElementById('claimDescription').value||'';
            if(amount <= 0){ alert('Enter a valid amount'); return; }
            
            const claimName = localStorage.getItem('ictUserName')||'';
            const claimEmail = localStorage.getItem('ictUserEmail')||'';
            
            const claim = { id, name: claimName, email: claimEmail, type, amount, date, receipt: receiptName, description: desc, status: 'Pending', approverDept: 'Finance', timestamp: new Date().toISOString() };
            const claims = JSON.parse(localStorage.getItem('claims')||'[]'); 
            claims.push(claim); 
            localStorage.setItem('claims', JSON.stringify(claims));

            // Create notification for claimant
            const notifications = JSON.parse(localStorage.getItem('userNotifications') || '[]');
            notifications.push({
                id: 'NOTIF-' + Date.now(),
                userEmail: claimEmail,
                claimId: id,
                message: `Claim submitted: ${id}\nStatus: Awaiting Finance Officer Review`,
                type: 'claim_submitted',
                createdAt: new Date().toISOString(),
                read: false
            });

            // Notify all finance users so assigned officers get alerted
            const financeUsers = JSON.parse(localStorage.getItem('financeUsers') || '[]');
            financeUsers.forEach(fu => {
                notifications.push({
                    id: 'NOTIF-' + Date.now() + '-' + (fu.email||'').replace(/[^a-z0-9@.]/gi,''),
                    userEmail: fu.email,
                    claimId: id,
                    message: `New claim ${id} submitted by ${claimName} - awaiting your review`,
                    type: 'new_claim_assigned',
                    createdAt: new Date().toISOString(),
                    read: false
                });
            });

            localStorage.setItem('userNotifications', JSON.stringify(notifications));

            // Create approval workflow for this claim so Finance users can approve/reject
            try {
                if (typeof ApprovalWorkflow !== 'undefined' && ApprovalWorkflow) {
                    const workflowConfig = {
                        moduleName: 'expense',
                        steps: [
                            { stepId: 'finance-officer-review', role: 'Finance Officer', department: 'Finance', approver: 'Finance Officer' },
                            { stepId: 'head-of-finance-review', role: 'Head of Finance', department: 'Finance', approver: 'Head of Finance' }
                        ]
                    };
                    const ictWorkflow = new ApprovalWorkflow(workflowConfig);
                    const claimData = {
                        id: id,
                        claimant: claimName,
                        email: claimEmail,
                        type: type,
                        amount: amount,
                        description: desc,
                        status: 'SUBMITTED'
                    };
                    ictWorkflow.createWorkflow(id, 'expense', claimData, claimEmail);
                    
                    // Also store workflow reference
                    const workflows = JSON.parse(localStorage.getItem('approvalWorkflows') || '[]');
                    const newWorkflow = {
                        id: 'WF-' + id,
                        requestId: id,
                        moduleName: 'expense',
                        data: claimData,
                        status: 'pending',
                        currentStep: 0,
                        steps: [
                            { stepId: 'finance-officer-review', role: 'Finance Officer', department: 'Finance', status: 'pending', approvedBy: null, comment: null },
                            { stepId: 'head-of-finance-review', role: 'Head of Finance', department: 'Finance', status: 'pending', approvedBy: null, comment: null }
                        ],
                        createdAt: new Date().toISOString(),
                        createdBy: claimEmail
                    };
                    workflows.push(newWorkflow);
                    localStorage.setItem('approvalWorkflows', JSON.stringify(workflows));
                }
            } catch(e) {
                console.warn('Could not create approval workflow:', e.message);
            }

            hideNewClaimForm(); 
            this.reset(); 
            loadClaims();
            alert('Claim submitted: ' + id);
        });

        // --- Leave Management Functions ---
        const PUBLIC_HOLIDAYS = ['2026-01-01'];
        function isPublicHoliday(dateStr) { return PUBLIC_HOLIDAYS.includes(dateStr); }
        function formatDateISO(d) { const yyyy = d.getFullYear(); const mm = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}`; }
        function calculateLeaveDays() {
            const startVal = document.getElementById('leaveStartDate').value;
            const endVal = document.getElementById('leaveEndDate').value;
            const daysEl = document.getElementById('leaveDays');
            if (!startVal || !endVal) { if(daysEl) daysEl.value = 0; return 0; }
            const start = new Date(startVal + 'T00:00:00');
            const end = new Date(endVal + 'T00:00:00');
            if (end < start) { if(daysEl) daysEl.value = 0; return 0; }
            let count = 0;
            for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
                const day = d.getDay(); if (day === 0 || day === 6) continue; const iso = formatDateISO(d); if (isPublicHoliday(iso)) continue; count++; }
            if(daysEl) daysEl.value = count; return count;
        }
        try { document.getElementById('leaveStartDate').addEventListener('change', calculateLeaveDays); } catch(e){}
        try { document.getElementById('leaveEndDate').addEventListener('change', calculateLeaveDays); } catch(e){}
        function getNextId(key){ const next = JSON.parse(localStorage.getItem('nextIds') || '{}'); if(!next[key]) next[key]=1; const id = next[key]++; localStorage.setItem('nextIds', JSON.stringify(next)); return String(id); }
        function showNewLeaveForm(){ try{ document.getElementById('leaveName').value = localStorage.getItem('ictUserName')||'';}catch(e){} try{ document.getElementById('leaveEmail').value = localStorage.getItem('ictUserEmail')||'';}catch(e){} document.getElementById('newLeaveForm').classList.remove('hidden'); updateLeaveTypeBalanceDisplay(); }
        function hideNewLeaveForm(){ document.getElementById('newLeaveForm').classList.add('hidden'); }
        function loadLeaveRequests(){ const reqs = JSON.parse(localStorage.getItem('leaveRequests')||'[]'); const isAdmin = localStorage.getItem('isAdmin')==='true'; const userEmail = localStorage.getItem('ictUserEmail')||localStorage.getItem('userEmail'); const filtered = isAdmin ? reqs : reqs.filter(r => (r.email||'') === (userEmail||'')); const tbody = document.getElementById('leaveList'); if(!tbody) return; if(filtered.length===0){ tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center">No leave requests</td></tr>'; return; } tbody.innerHTML = filtered.map(r=>`<tr><td class="p-2">${r.id}</td><td class="p-2">${r.name||''}</td><td class="p-2">${r.email||''}</td><td class="p-2">${r.type}</td><td class="p-2">${r.startDate||''}</td><td class="p-2">${r.endDate||''}</td><td class="p-2">${r.resumeDate||''}</td><td class="p-2">${r.days}</td><td class="p-2">${r.status}</td></tr>`).join(''); }
        document.addEventListener('submit', function(e){ if(e.target && e.target.id==='leaveFormEl'){ e.preventDefault(); const id = getNextId('leaveRequests'); const start = document.getElementById('leaveStartDate').value; const end = document.getElementById('leaveEndDate').value; const resume = document.getElementById('leaveResumeDate').value; const daysCalculated = calculateLeaveDays(); if(daysCalculated<=0){ alert('Invalid leave range or zero working days selected.'); return; } const req = { id, name: localStorage.getItem('ictUserName')||'', email: localStorage.getItem('ictUserEmail')||localStorage.getItem('userEmail'), type: document.getElementById('leaveType').value, days: daysCalculated, startDate: start, endDate: end, resumeDate: resume, reason: document.getElementById('leaveReason').value||'', status: 'Pending', approverDept: 'Admin', timestamp: new Date().toISOString() }; const reqs = JSON.parse(localStorage.getItem('leaveRequests')||'[]'); reqs.push(req); localStorage.setItem('leaveRequests', JSON.stringify(reqs)); hideNewLeaveForm(); e.target.reset(); loadLeaveRequests(); alert('Leave request submitted: '+id); } });
        function updateLeaveTypeBalanceDisplay(){ const type = (document.getElementById('leaveType').value||'').toLowerCase(); const email = (localStorage.getItem('ictUserEmail')||localStorage.getItem('userEmail')||'').toLowerCase(); const employees = JSON.parse(localStorage.getItem('employees')||'[]'); const u = employees.find(e=> (e.email||'').toLowerCase()===email); let val = 0; if(u && u.leaveBalances){ if(type==='annual') val = u.leaveBalances.annual||0; else if(type==='sick') val = u.leaveBalances.sick||0; else if(type==='personal') val = u.leaveBalances.personal||0; } let helper = document.getElementById('leaveTypeHelper'); if(!helper){ helper = document.createElement('p'); helper.id = 'leaveTypeHelper'; helper.className = 'text-xs text-gray-500 mt-1'; document.getElementById('leaveType').parentNode.appendChild(helper); } helper.textContent = 'Available balance: ' + val + ' days'; }
        try{ document.getElementById('leaveType').addEventListener('change', updateLeaveTypeBalanceDisplay); } catch(e){}

        // --- Asset Register JS ---
        function saveAssetsToStorage(list) {
            localStorage.setItem('ictAssets', JSON.stringify(list || []));
        }

        function loadAssets() {
            const list = JSON.parse(localStorage.getItem('ictAssets') || '[]');
            renderAssetList(list);
        }

        function renderAssetList(list) {
            const tbody = document.getElementById('assetListBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td class="p-4 text-center" colspan="7">No assets registered</td></tr>';
                return;
            }
            list.forEach(a => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2">${a.tag || ''}</td>
                    <td class="p-2">${a.name || ''}</td>
                    <td class="p-2">${a.category || ''}</td>
                    <td class="p-2">${a.location || ''}</td>
                    <td class="p-2">${a.status || ''}</td>
                    <td class="p-2">${a.purchased || ''}</td>
                    <td class="p-2">
                        <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" onclick="deleteAsset('${a.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function generateAssetId() {
            return 'A' + Date.now() + Math.floor(Math.random() * 1000);
        }

        function deleteAsset(id) {
            let list = JSON.parse(localStorage.getItem('ictAssets') || '[]');
            list = list.filter(a => a.id !== id);
            saveAssetsToStorage(list);
            renderAssetList(list);
        }

        // UI wiring for asset form/buttons
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'toggleNewAssetBtn') {
                document.getElementById('newAssetForm').classList.toggle('hidden');
            }
            if (e.target && e.target.id === 'cancelNewAssetBtn') {
                document.getElementById('newAssetForm').classList.add('hidden');
            }
            if (e.target && e.target.id === 'exportAssetsBtn') {
                const list = JSON.parse(localStorage.getItem('ictAssets') || '[]');
                const data = JSON.stringify(list, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ict-assets.json';
                a.click();
                URL.revokeObjectURL(url);
            }
        });

        document.getElementById('newAssetForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const tag = document.getElementById('assetTag').value.trim();
            const name = document.getElementById('assetName').value.trim();
            const category = document.getElementById('assetCategory').value.trim();
            const location = document.getElementById('assetLocation').value.trim();
            const status = document.getElementById('assetStatus').value;
            const purchased = document.getElementById('assetPurchaseDate').value;

            const list = JSON.parse(localStorage.getItem('ictAssets') || '[]');
            const asset = { id: generateAssetId(), tag, name, category, location, status, purchased };
            list.unshift(asset);
            saveAssetsToStorage(list);
            renderAssetList(list);

            // clear & hide form
            document.getElementById('assetTag').value = '';
            document.getElementById('assetName').value = '';
            document.getElementById('assetCategory').value = '';
            document.getElementById('assetLocation').value = '';
            document.getElementById('assetStatus').value = 'In Use';
            document.getElementById('assetPurchaseDate').value = '';
            document.getElementById('newAssetForm').classList.add('hidden');
        });

        
        function getNextId(key){ const next = JSON.parse(localStorage.getItem('nextIds') || '{}'); if(!next[key]) next[key]=1; const id = next[key]++; localStorage.setItem('nextIds', JSON.stringify(next)); return String(id); }
        function showNewLeaveForm(){ try{ document.getElementById('leaveName').value = localStorage.getItem('ictUserName')||'';}catch(e){} try{ document.getElementById('leaveEmail').value = localStorage.getItem('ictUserEmail')||'';}catch(e){} document.getElementById('newLeaveForm').classList.remove('hidden'); updateLeaveTypeBalanceDisplay(); }
        function hideNewLeaveForm(){ document.getElementById('newLeaveForm').classList.add('hidden'); }
        function loadLeaveRequests(){ const reqs = JSON.parse(localStorage.getItem('leaveRequests')||'[]'); const isAdmin = localStorage.getItem('isAdmin')==='true'; const userEmail = localStorage.getItem('ictUserEmail')||localStorage.getItem('userEmail'); const filtered = isAdmin ? reqs : reqs.filter(r => (r.email||'') === (userEmail||'')); const tbody = document.getElementById('leaveList'); if(!tbody) return; if(filtered.length===0){ tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center">No leave requests</td></tr>'; return; } tbody.innerHTML = filtered.map(r=>`<tr><td class="p-2">${r.id}</td><td class="p-2">${r.name||''}</td><td class="p-2">${r.email||''}</td><td class="p-2">${r.type}</td><td class="p-2">${r.startDate||''}</td><td class="p-2">${r.endDate||''}</td><td class="p-2">${r.resumeDate||''}</td><td class="p-2">${r.days}</td><td class="p-2">${r.status}</td></tr>`).join(''); }
        document.addEventListener('submit', function(e){ if(e.target && e.target.id==='leaveFormEl'){ e.preventDefault(); const id = getNextId('leaveRequests'); const start = document.getElementById('leaveStartDate').value; const end = document.getElementById('leaveEndDate').value; const resume = document.getElementById('leaveResumeDate').value; const daysCalculated = calculateLeaveDays(); if(daysCalculated<=0){ alert('Invalid leave range or zero working days selected.'); return; } const req = { id, name: localStorage.getItem('ictUserName')||'', email: localStorage.getItem('ictUserEmail')||localStorage.getItem('userEmail'), type: document.getElementById('leaveType').value, days: daysCalculated, startDate: start, endDate: end, resumeDate: resume, reason: document.getElementById('leaveReason').value||'', status: 'Pending', approverDept: 'Admin', timestamp: new Date().toISOString() }; const reqs = JSON.parse(localStorage.getItem('leaveRequests')||'[]'); reqs.push(req); localStorage.setItem('leaveRequests', JSON.stringify(reqs)); hideNewLeaveForm(); e.target.reset(); loadLeaveRequests(); alert('Leave request submitted: '+id); } });
        function updateLeaveTypeBalanceDisplay(){ const type = (document.getElementById('leaveType').value||'').toLowerCase(); const email = (localStorage.getItem('ictUserEmail')||localStorage.getItem('userEmail')||'').toLowerCase(); const employees = JSON.parse(localStorage.getItem('employees')||'[]'); const u = employees.find(e=> (e.email||'').toLowerCase()===email); let val = 0; if(u && u.leaveBalances){ if(type==='annual') val = u.leaveBalances.annual||0; else if(type==='sick') val = u.leaveBalances.sick||0; else if(type==='personal') val = u.leaveBalances.personal||0; } let helper = document.getElementById('leaveTypeHelper'); if(!helper){ helper = document.createElement('p'); helper.id = 'leaveTypeHelper'; helper.className = 'text-xs text-gray-500 mt-1'; document.getElementById('leaveType').parentNode.appendChild(helper); } helper.textContent = 'Available balance: ' + val + ' days'; }
        try{ document.getElementById('leaveType').addEventListener('change', updateLeaveTypeBalanceDisplay); } catch(e){}

        // Auto-create demo ICT users on first load if needed
        window.addEventListener('load', function() {
            // Ensure demo ICT users exist before attempting to populate the select
            const ictUsers = JSON.parse(localStorage.getItem('ictUsers') || '[]');
            if (ictUsers.length === 0) {
                const demoUsers = [
                    { name: 'Robert Tech', email: 'tech.ict@onit.local', password: '1234', role: 'IT Support', department: 'ICT' },
                    { name: 'Diana Systems', email: 'systems.ict@onit.local', password: '1234', role: 'Systems Admin', department: 'ICT' },
                    { name: 'Eric Infrastructure', email: 'infra.ict@onit.local', password: '1234', role: 'Infrastructure', department: 'ICT' }
                ];
                localStorage.setItem('ictUsers', JSON.stringify(demoUsers));
            }
            try{ populateIctUsers(); } catch(e){ console.warn('populateIctUsers call failed', e); }

            // Check if user is already logged in
            if (localStorage.getItem('ictUserEmail')) {
                const name = localStorage.getItem('ictUserName');

                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('ictPortal').classList.remove('hidden');
                document.getElementById('ictUserDisplay').textContent = name;
                document.getElementById('ictRoleDisplay').textContent = 'ICT';

                loadIctDashboard();
                loadAssets();
                loadLeaveRequests();
            }
            // ensure assets are loaded for the page (even if not logged-in state changed)
            loadAssets();
        });
    </script>
    <script src="approval-workflow.js"></script>
</body>
</html>
