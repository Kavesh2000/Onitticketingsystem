<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Portal </title>
    <link rel="icon" href="assets/onit-logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sidebar-link { transition: all 0.3s ease; }
        .sidebar-link:hover { background-color: rgba(255,255,255,0.06); transform: translateX(4px); }
        .sidebar-link.active { background-color: rgba(255,255,255,0.08); border-left: 4px solid rgba(255,255,255,0.12); }
        .content-section { display: none; }
        .content-section.active { display: block; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Login Screen -->
    <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-600 to-blue-900">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h1 class="text-3xl font-bold text-center mb-2">Finance Portal</h1>
            <button type="button" onclick="window.location.href='index.html'" class="text-blue-600 hover:text-blue-700 text-sm mb-4">‚Üê Back</button>
         
            
            <form id="financeLoginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Email</label>
                    <select id="financeUserEmail" required class="w-full p-3 border rounded focus:outline-none focus:border-blue-500">
                        <option value="">Loading users...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold mb-2">Password</label>
                    <input type="password" id="financeUserPassword" placeholder="Password" required class="w-full p-3 border rounded focus:outline-none focus:border-blue-500" />
                </div>
                
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded">Login</button>
            </form>
        </div>
    </div>

    <script>
    // Finance Portal Login Handler - DELAYED INIT
    let financeLoginInitialized = false;
    
    // ===== FUNCTION DEFINITIONS (defined first) =====
    
    // Load Finance Dashboard
    function loadFinanceDashboard() {
        try {
            console.log('[DASHBOARD] Loading finance dashboard');
            const userEmail = localStorage.getItem('financeUserEmail');
            const userRole = localStorage.getItem('financeUserRole');
            
            // Get stats
            const workflows = JSON.parse(localStorage.getItem('approvalWorkflows')||'[]');
            const expenseClaims = workflows.filter(w => (w.module || w.moduleName) === 'expense');
            
            const pendingForReview = expenseClaims.filter(wf => {
                if(wf.status !== 'in-progress' && wf.status !== 'pending') return false;
                const currentStep = wf.steps?.[wf.currentStep];
                return currentStep && currentStep.role === userRole && currentStep.status === 'pending';
            }).length;
            
            const approvedThisMonth = expenseClaims.filter(wf => {
                const createdDate = new Date(wf.createdAt);
                const isThisMonth = createdDate.getMonth() === new Date().getMonth() && 
                                  createdDate.getFullYear() === new Date().getFullYear();
                return wf.status === 'approved' && isThisMonth;
            }).length;
            
            // Dashboard claims cards removed - claims management is now only in Manage Claims section
            
            console.log('[DASHBOARD] Updated with', expenseClaims.length, 'claims');
        } catch(e) {
            console.error('[DASHBOARD] Error:', e);
        }
    }

    // Load Claims (My Expense Claims)
    function loadClaims() {
        try {
            console.log('[CLAIMS] Loading my expense claims');
            const userEmail = localStorage.getItem('financeUserEmail');
            const claims = JSON.parse(localStorage.getItem('claims')||'[]');
            const userClaims = claims.filter(c => c.email === userEmail);
            
            const tbody = document.getElementById('claimsList');
            if (!tbody) return;
            
            if (userClaims.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center">No claims submitted</td></tr>';
                return;
            }
            
            tbody.innerHTML = userClaims.map(c => `
                <tr><td class="p-2">${c.id}</td><td class="p-2">${c.name||''}</td><td class="p-2">${c.email||''}</td><td class="p-2">${c.type}</td><td class="p-2">KSH ${parseFloat(c.amount).toLocaleString('en-KE', {minimumFractionDigits: 2})}</td><td class="p-2">${c.date||''}</td><td class="p-2">${c.status}</td></tr>
            `).join('');
        } catch(e) { console.error('[CLAIMS]', e); }
    }

    // Load Leave Requests
    function loadLeaveRequests() {
        try {
            console.log('[LEAVE] Loading leave requests');
            const userEmail = localStorage.getItem('financeUserEmail');
            const reqs = JSON.parse(localStorage.getItem('leaveRequests')||'[]');
            const userReqs = reqs.filter(r => r.email === userEmail);
            
            const tbody = document.getElementById('leaveList');
            if (!tbody) return;
            
            if (userReqs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center">No leave requests</td></tr>';
                return;
            }
            
            tbody.innerHTML = userReqs.map(r => `
                <tr><td class="p-2">${r.id}</td><td class="p-2">${r.name||''}</td><td class="p-2">${r.email||''}</td><td class="p-2">${r.type}</td><td class="p-2">${r.startDate||''}</td><td class="p-2">${r.endDate||''}</td><td class="p-2">${r.resumeDate||''}</td><td class="p-2">${r.days}</td><td class="p-2">${r.status}</td></tr>
            `).join('');
        } catch(e) { console.error('[LEAVE]', e); }
    }

    // Load Approval History
    function loadApprovalHistory() {
        try {
            console.log('[HISTORY] Loading approval history');
            const userEmail = localStorage.getItem('financeUserEmail');
            const auditLogs = JSON.parse(localStorage.getItem('approvalAuditLogs')||'[]');
            const userActions = auditLogs.filter(log => log.actor === userEmail);
            
            const container = document.getElementById('approvalHistoryList');
            if (!container) return;
            
            if (userActions.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No approval or rejection history</p>';
                return;
            }
            
            // Sort by newest first
            userActions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = userActions.map(log => {
                const borderColor = log.action === 'STEP_APPROVED' ? 'border-green-500' : 'border-red-500';
                const bgColor = log.action === 'STEP_APPROVED' ? 'bg-green-50' : 'bg-red-50';
                const actionLabel = log.action === 'STEP_APPROVED' ? '‚úÖ APPROVED' : '‚ùå REJECTED';
                const claimId = parseInt(log.claimId) || log.requestId || 'N/A';
                const amount = parseFloat(log.amount || 0).toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                return `
                    <div class="${bgColor} p-4 rounded shadow border-l-4 ${borderColor}">
                        <div class="flex justify-between items-start mb-2">
                            <p><strong>Claim ID:</strong> <span class="font-mono text-lg">${claimId}</span></p>
                            <span class="text-xs font-bold px-2 py-1 rounded ${log.action === 'STEP_APPROVED' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${actionLabel}</span>
                        </div>
                        <p><strong>Amount:</strong> KSH ${amount}</p>
                        <p><strong>Type:</strong> ${log.type || 'Expense'}</p>
                        <p><strong>Step:</strong> ${log.step}</p>
                        <p><strong>Reason:</strong> ${log.details || log.comment || 'N/A'}</p>
                        <p class="text-xs text-gray-600 mt-2"><strong>Date:</strong> ${new Date(log.timestamp).toLocaleString()}</p>
                    </div>
                `;
            }).join('');
        } catch(e) { console.error('[HISTORY]', e); }
    }

    // Load Finance Claims (for review)
    function loadFinanceClaims() {
        try {
            console.log('[CLAIMS] Loading finance claims to review');
            const userEmail = localStorage.getItem('financeUserEmail');
            const userRole = localStorage.getItem('financeUserRole');
            
            // Collect claims from multiple sources
            const allClaims = [];
            
            // 1. From approval workflows - only pending ones
            const workflows = JSON.parse(localStorage.getItem('approvalWorkflows')||'[]');
            const workflowClaims = workflows.filter(w => {
                const isPending = w.status === 'in-progress' || w.status === 'pending';
                const isExpense = (w.module || w.moduleName) === 'expense' || w.type === 'expense';
                return isPending && isExpense;
            });
            workflowClaims.forEach(wf => {
                allClaims.push({
                    id: wf.id || wf.requestId,
                    claimant: wf.claimant || wf.data?.claimant,
                    email: wf.data?.email,
                    type: wf.data?.type,
                    amount: wf.data?.amount,
                    status: wf.status,
                    source: 'workflow'
                });
            });
            
            // 2. From regular claims storage (pending claims not yet in workflows)
            const genericClaims = JSON.parse(localStorage.getItem('claims')||'[]');
            const pendingClaims = genericClaims.filter(c => c.status === 'Pending' && c.approverDept === 'Finance');
            pendingClaims.forEach(c => {
                // Check if this claim is already in allClaims to avoid duplicates
                const isDuplicate = allClaims.some(ac => ac.id === c.id && ac.email === c.email);
                if (!isDuplicate) {
                    allClaims.push({
                        id: c.id,
                        claimant: c.name,
                        email: c.email,
                        type: c.type,
                        amount: c.amount,
                        status: c.status,
                        source: 'claim'
                    });
                }
            });
            
            const tbody = document.getElementById('financeClaimsList');
            if (!tbody) {
                console.warn('[CLAIMS] Claims table not found');
                return;
            }
            
            if (allClaims.length === 0) {
                tbody.innerHTML = '<tr><td class="p-4 text-center" colspan="7">No claims to review</td></tr>';
                return;
            }
            
            tbody.innerHTML = allClaims.map(claim => `
                <tr class="hover:bg-gray-50">
                    <td class="p-3 font-mono">${claim.id || '-'}</td>
                    <td class="p-3">${claim.claimant || '-'}</td>
                    <td class="p-3">${claim.type || '-'}</td>
                    <td class="p-3">KSH ${parseFloat(claim.amount || 0).toLocaleString('en-KE', {minimumFractionDigits: 2})}</td>
                    <td class="p-3">Review</td>
                    <td class="p-3"><span class="px-2 py-1 rounded text-xs font-semibold bg-yellow-100 text-yellow-800">${claim.status || 'Pending'}</span></td>
                    <td class="p-3"><button onclick="window.showFinanceClaimModal('${claim.id}', '${claim.id}')" class="text-blue-600 hover:underline">Review</button></td>
                </tr>
            `).join('');
            
            console.log('[CLAIMS] Loaded', allClaims.length, 'unique claims for review');
        } catch(e) {
            console.error('[CLAIMS] Error:', e);
        }
    }

    // Load Finance Tickets
    function loadFinanceTickets() {
        try {
            console.log('[TICKETS] Loading finance tickets');
            const userEmail = localStorage.getItem('financeUserEmail');
            const allTickets = JSON.parse(localStorage.getItem('tickets') || '[]');
            const financeTickets = allTickets.filter(t => (t.department || '').toLowerCase() === 'finance');
            const tbody = document.getElementById('financeTicketsList');
            
            if (!tbody) return;
            
            if (financeTickets.length === 0) {
                tbody.innerHTML = '<tr><td class="p-4 text-center" colspan="7">No tickets</td></tr>';
                return;
            }
            
            tbody.innerHTML = financeTickets.map(t => `
                <tr class="hover:bg-gray-50">
                    <td class="p-3">${t.id}</td>
                    <td class="p-3">${t.subject || ''}</td>
                    <td class="p-3">${t.type || ''}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded text-xs font-semibold">${t.priority || 'Low'}</span></td>
                    <td class="p-3">${t.createdDate || (t.timestamp ? t.timestamp.split('T')[0] : '')}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded text-xs font-semibold">${t.status}</span></td>
                    <td class="p-3">
                        <div class="flex items-center gap-2">
                            <button onclick="viewTicketDetails('${t.id}')" class="text-blue-600 hover:underline text-sm">View</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } catch(e) { console.error('[TICKETS]', e); }
    }

    // Switch Finance Section (GLOBAL - accessible from onclick)
    window.switchFinanceSection = function(id) {
        console.log('[MENU] Switching to section:', id);
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.sidebar-link').forEach(s => s.classList.remove('active'));
        
        const section = document.getElementById(id);
        if (section) {
            section.classList.add('active');
        } else {
            console.error('[MENU] Section not found:', id);
        }
        
        // Update sidebar button active state
        const buttons = document.querySelectorAll('.sidebar-link');
        buttons.forEach(btn => {
            if (btn.textContent.includes(id === 'dashboard' ? 'Dashboard' : 
                                       id === 'myexpenses' ? 'My Expense' :
                                       id === 'claims' ? 'Manage Claims' :
                                       id === 'leave' ? 'Leave' :
                                       id === 'history' ? 'History' :
                                       id === 'tickets' ? 'Tickets' : '')) {
                btn.classList.add('active');
            }
        });
        
        // Load data
        if(id === 'dashboard') loadFinanceDashboard();
        else if(id === 'myexpenses') loadClaims();
        else if(id === 'leave') loadLeaveRequests();
        else if(id === 'claims') loadFinanceClaims();
        else if(id === 'history') loadApprovalHistory();
        else if(id === 'tickets') loadFinanceTickets();
    };

    // Finance Logout (GLOBAL - accessible from onclick)
    window.financeLogout = function() {
        console.log('[LOGOUT] Logging out user');
        localStorage.removeItem('financeUserName');
        localStorage.removeItem('financeUserEmail');
        localStorage.removeItem('financeUserRole');
        localStorage.removeItem('financeUserDept');
        localStorage.removeItem('financeUserId');
        
        document.getElementById('financePortal').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('financeLoginForm').reset();
        console.log('[LOGOUT] ‚úÖ Logged out');
    };

    // Initialize Login Handler (called after functions are defined)
    function initFinanceLoginHandler() {
        if (financeLoginInitialized) return;
        financeLoginInitialized = true;
        
        const form = document.getElementById('financeLoginForm');
        
        // Load finance users into dropdown
        async function loadFinanceUsers() {
            try {
                const resp = await fetch('/api/users');
                if (!resp || resp.status !== 200) {
                    console.error('[LOGIN] Failed to fetch users, status:', resp?.status);
                    return;
                }
                const data = await resp.json();
                let users = data.users || [];
                users = users.filter(u => (u.department || '').toLowerCase() === 'finance');
                
                const emailSel = document.getElementById('financeUserEmail');
                if (!emailSel) {
                    console.error('[LOGIN] Email select not found');
                    return;
                }
                
                emailSel.innerHTML = '<option value="">Select Email</option>';
                users.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.email;
                    opt.textContent = u.email;
                    opt.dataset.role = u.role || '';
                    opt.dataset.userId = u.id || '';
                    emailSel.appendChild(opt);
                });
                console.log('[LOGIN] Loaded', users.length, 'finance users');
            } catch(e) {
                console.error('[LOGIN] Error loading users:', e.message);
            }
        }
        
        // Handle login form submission
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('[LOGIN] Form submitted');
                
                const email = document.getElementById('financeUserEmail').value?.trim();
                const password = document.getElementById('financeUserPassword').value;
                const emailOpt = document.getElementById('financeUserEmail').options[document.getElementById('financeUserEmail').selectedIndex];
                const selectedRole = emailOpt?.dataset?.role || '';
                
                if (!email || !password || !selectedRole) {
                    alert('‚ùå Please select an email, enter password, and ensure user has a role');
                    return;
                }
                
                console.log('[LOGIN] Authenticating:', email, 'role:', selectedRole);
                
                try {
                    // Call backend auth API
                    const resp = await fetch('/api/auth', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    
                    if (!resp || resp.status !== 200) {
                        console.error('[LOGIN] Auth failed, status:', resp?.status);
                        alert('‚ùå Unable to contact authentication server (status: ' + (resp?.status || 'unknown') + ')');
                        return;
                    }
                    
                    const data = await resp.json();
                    console.log('[LOGIN] Auth response:', data);
                    
                    if (!data || !data.success || !data.user) {
                        alert('‚ùå Invalid email or password. Ask admin for credentials.');
                        return;
                    }
                    
                    const user = data.user;
                    
                    // Validate role and department
                    if (user.role !== selectedRole) {
                        alert('‚ùå Selected role does not match user role: ' + user.role);
                        return;
                    }
                    
                    if ((user.department || '').toLowerCase() !== 'finance') {
                        alert('‚ùå User is not in Finance department');
                        return;
                    }
                    
                    // Save session
                    localStorage.setItem('financeUserName', user.full_name || user.email);
                    localStorage.setItem('financeUserEmail', user.email);
                    localStorage.setItem('financeUserRole', user.role);
                    localStorage.setItem('financeUserDept', user.department || 'Finance');
                    localStorage.setItem('financeUserId', user.id);
                    localStorage.setItem('userDept', user.department || 'Finance');
                    
                    console.log('[LOGIN] Session saved for:', user.email);
                    
                    // Show portal
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('financePortal').classList.remove('hidden');
                    
                    // Display user info
                    const userDisplayEl = document.getElementById('financeUserDisplay');
                    const roleDisplayEl = document.getElementById('financeRoleDisplay');
                    if (userDisplayEl) userDisplayEl.textContent = user.full_name || 'User';
                    if (roleDisplayEl) roleDisplayEl.textContent = user.role;
                    
                    // Load dashboard
                    loadFinanceDashboard();
                    
                    console.log('[LOGIN] ‚úÖ Login successful for:', user.email);
                } catch(err) {
                    console.error('[LOGIN] Exception:', err);
                    alert('‚ùå Login error: ' + (err?.message || err));
                }
            });
        } else {
            console.error('[LOGIN] Form element not found');
        }
        
        // Load users on init
        loadFinanceUsers();
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFinanceLoginHandler);
    } else {
        initFinanceLoginHandler();
    }
    </script>

    <!-- Finance Portal Dashboard -->
    <div id="financePortal" class="hidden flex h-screen">
        <aside class="w-64 bg-gradient-to-b from-blue-700 to-blue-900 text-white p-6">
            <div class="mb-6 pb-6 border-b border-blue-600 flex items-center gap-3">
                <img src="assets/onit-logo.png" alt="Onit MFB logo" class="w-12 h-12 object-contain">
                <div>
                    <h1 class="text-xl font-bold">Onit</h1>
                    <p class="text-xs text-blue-200">MFB - Finance</p>
                </div>
            </div>
            <div class="mb-4 pb-4 border-b border-blue-600">
                <p class="text-sm text-blue-100">Logged in as:</p>
                <p id="financeUserDisplay" class="font-semibold">-</p>
                <p id="financeRoleDisplay" class="text-xs text-blue-200">-</p>
            </div>
            <nav class="space-y-2">
                <button onclick="switchFinanceSection('dashboard')" class="sidebar-link active w-full text-left px-4 py-3 rounded">üìä Dashboard</button>
                <button onclick="switchFinanceSection('myexpenses')" class="sidebar-link w-full text-left px-4 py-3 rounded">üí∞ My Expense Claims</button>
                <button onclick="switchFinanceSection('leave')" class="sidebar-link w-full text-left px-4 py-3 rounded">üèñÔ∏è Leave</button>
                <button onclick="switchFinanceSection('claims')" class="sidebar-link w-full text-left px-4 py-3 rounded">üìã Manage Claims</button>
                <button onclick="switchFinanceSection('history')" class="sidebar-link w-full text-left px-4 py-3 rounded">üìú Approval History</button>
                <button onclick="switchFinanceSection('tickets')" class="sidebar-link w-full text-left px-4 py-3 rounded">üé´ Tickets</button>
            </nav>
            <div class="mt-8 pt-8 border-t border-blue-600">
                <button onclick="financeLogout()" class="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded">üö™ Logout</button>
            </div>
        </aside>

        <main class="flex-1 overflow-auto">
            <!-- Dashboard -->
            <div id="dashboard" class="content-section active p-8">
                <h2 class="text-3xl font-bold mb-6">Finance Dashboard</h2>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">


                    <!-- Leave Balance Card -->
                    <div class="bg-white rounded-lg shadow-md p-6 border-t-4 border-purple-500 hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Leave Balance</p>
                                <p class="text-3xl font-bold text-purple-600 mt-2" id="dashboardLeaveFin">0</p>
                            </div>
                            <div class="text-5xl text-purple-200">üèñÔ∏è</div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">Days: <span class="font-semibold text-purple-600" id="leaveDays">0</span></p>
                    </div>
                </div>

                <!-- Leave Balances -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Leave Balance - Your Account</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <p class="text-gray-600 text-sm font-semibold">Annual Leave</p>
                            <p class="text-3xl font-bold text-blue-600 mt-2" id="balAnnual">0</p>
                            <p class="text-xs text-gray-500 mt-1">days remaining</p>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg border border-red-200">
                            <p class="text-gray-600 text-sm font-semibold">Sick Leave</p>
                            <p class="text-3xl font-bold text-red-600 mt-2" id="balSick">0</p>
                            <p class="text-xs text-gray-500 mt-1">days remaining</p>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <p class="text-gray-600 text-sm font-semibold">Personal Leave</p>
                            <p class="text-3xl font-bold text-yellow-600 mt-2" id="balPersonal">0</p>
                            <p class="text-xs text-gray-500 mt-1">days remaining</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Expense Claims Section -->
            <div id="myexpenses" class="content-section p-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Finance - Expense Claims</h2>
                    <button onclick="window.showNewClaimForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">+ New Claim</button>
                </div>
                <div id="newClaimForm" class="hidden card mb-4">
                    <h3 class="font-semibold mb-4">Submit Expense Claim</h3>
                    <form id="claimFormEl" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Name</label>
                                <input id="claimName" type="text" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Email</label>
                                <input id="claimEmail" type="email" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Expense Type</label>
                                <select id="claimType" required class="p-2 border rounded w-full mt-1"><option value="Travel">Travel</option><option value="Meals">Meals</option><option value="Supplies">Supplies</option><option value="Other">Other</option></select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Amount</label>
                                <input id="claimAmount" type="number" min="0" step="0.01" required class="w-full p-2 border rounded mt-1" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Date</label>
                                <input id="claimDate" type="date" required class="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Receipt (optional)</label>
                                <input id="claimReceipt" type="file" class="w-full mt-1" />
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">Description (optional)</label>
                            <textarea id="claimDescription" rows="3" class="w-full p-2 border rounded mt-1" placeholder="Details about the expense"></textarea>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" type="submit">Submit Claim</button>
                            <button type="button" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" onclick="window.hideNewClaimForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded shadow p-4">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-blue-600 to-blue-800 text-white"><tr><th class="p-3 text-left font-bold">üìã ID</th><th class="p-3 text-left font-bold">üë§ Name</th><th class="p-3 text-left font-bold">üìß Email</th><th class="p-3 text-left font-bold">üí∞ Type</th><th class="p-3 text-left font-bold">üíµ Amount</th><th class="p-3 text-left font-bold">üìÖ Date</th><th class="p-3 text-left font-bold">‚úì Status</th></tr></thead>
                        <tbody id="claimsList"><tr><td class="p-4 text-center" colspan="7">No claims</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Leave Management -->
            <div id="leave" class="content-section p-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Leave Management</h2>
                    <button onclick="window.showNewLeaveForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">+ Request Leave</button>
                </div>
                <div id="newLeaveForm" class="hidden card mb-4">
                    <form id="leaveFormEl" class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Name</label>
                                <input id="leaveName" type="text" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Email</label>
                                <input id="leaveEmail" type="email" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Leave Type</label>
                                <select id="leaveType" required class="p-2 border rounded w-full mt-1"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Personal">Personal</option></select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Start Date</label>
                                <input id="leaveStartDate" type="date" required class="w-full p-2 border rounded mt-1" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">End Date</label>
                                <input id="leaveEndDate" type="date" required class="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Days</label>
                                <input id="leaveDays" type="number" min="0" required class="w-full input mt-1" placeholder="Calculated automatically" readonly />
                                <p class="text-xs text-gray-500 mt-1">Excludes weekends and public holidays.</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Resume Work On</label>
                                <input id="leaveResumeDate" type="date" required class="w-full p-2 border rounded mt-1" />
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">Reason (optional)</label>
                            <textarea id="leaveReason" rows="3" class="w-full p-2 border rounded mt-1" placeholder="Reason for leave"></textarea>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" type="submit">Submit Request</button>
                            <button type="button" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded" onclick="window.hideNewLeaveForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded shadow p-4">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-orange-600 to-orange-800 text-white"><tr><th class="p-3 text-left font-bold">üìã ID</th><th class="p-3 text-left font-bold">üë§ Name</th><th class="p-3 text-left font-bold">üìß Email</th><th class="p-3 text-left font-bold">üèñÔ∏è Type</th><th class="p-3 text-left font-bold">üìÖ Start Date</th><th class="p-3 text-left font-bold">üìÖ End Date</th><th class="p-3 text-left font-bold">üìÖ Resume Date</th><th class="p-3 text-left font-bold">‚è±Ô∏è Days</th><th class="p-3 text-left font-bold">‚úì Status</th></tr></thead>
                        <tbody id="leaveList"><tr><td class="p-4 text-center" colspan="9">No leave requests</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Manage Claims Section -->
            <div id="claims" class="content-section active p-8">
                <h2 class="text-3xl font-bold mb-6">Manage Claims</h2>
                <div class="bg-white rounded shadow p-4 mb-4">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-left">ID</th>
                                <th class="p-3 text-left">Claimant</th>
                                <th class="p-3 text-left">Type</th>
                                <th class="p-3 text-left">Amount</th>
                                <th class="p-3 text-left">Current Step</th>
                                <th class="p-3 text-left">Status</th>
                                <th class="p-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="financeClaimsList">
                            <tr><td class="p-4 text-center" colspan="7">No claims to review</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Approval History Section -->
            <div id="history" class="content-section p-8">
                <h2 class="text-3xl font-bold mb-6">Approval History</h2>
                <div class="bg-white rounded shadow p-4">
                    <div id="approvalHistoryList" class="space-y-4">
                        <p class="text-gray-500">No approval history</p>
                    </div>
                </div>
            </div>

            <!-- Tickets Section -->
            <div id="tickets" class="content-section p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Support Tickets</h2>
                    <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" onclick="document.getElementById('newFinanceTicketForm').classList.toggle('hidden')">+ New Ticket</button>
                </div>
                <div id="newFinanceTicketForm" class="bg-white rounded shadow p-4 mb-4 hidden">
                    <h3 class="font-semibold mb-4">Submit New Ticket</h3>
                    <form id="financeTicketFormEl" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Subject</label>
                                <input id="financeTicketSubject" placeholder="Short title" required class="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Type</label>
                                <select id="financeTicketType" class="w-full p-2 border rounded mt-1">
                                    <option value="Request">Request</option>
                                    <option value="Issue">Issue</option>
                                    <option value="Bug">Bug</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Department</label>
                                <select id="financeTicketDepartment" class="w-full p-2 border rounded mt-1">
                                    <option value="Branch">Branch</option>
                                    <option value="ICT">ICT</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Submitting For</label>
                                <select id="financeTicketSubmittingFor" class="w-full p-2 border rounded mt-1">
                                    <option value="">Select type</option>
                                    <option value="Customer">Customer</option>
                                    <option value="User">User</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">Description</label>
                            <textarea id="financeTicketDescription" placeholder="What happened? Provide steps or context." required class="w-full p-2 border rounded mt-1" rows="4"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
                            <div>
                                <label class="text-sm font-medium">Priority</label>
                                <select id="financeTicketPriority" class="w-full input mt-1">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Due Date (optional)</label>
                                <input id="financeTicketDueDate" type="date" class="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Attachment (optional)</label>
                                <input id="financeTicketAttachment" type="file" class="w-full mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Created Date</label>
                                <input id="financeTicketCreatedDate" type="date" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" type="submit">Submit Ticket</button>
                            <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded" onclick="document.getElementById('newFinanceTicketForm').classList.add('hidden')">Cancel</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white rounded shadow p-4">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 text-left">ID</th>
                                <th class="p-3 text-left">Subject</th>
                                <th class="p-3 text-left">Type</th>
                                <th class="p-3 text-left">Priority</th>
                                <th class="p-3 text-left">Created</th>
                                <th class="p-3 text-left">Status</th>
                                <th class="p-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="financeTicketsList">
                            <tr><td class="p-4 text-center" colspan="7">No tickets assigned</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Claim Review Modal -->
    <div id="financeApprovalModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4">Review Claim</h3>
            <div id="financeClaimDetails" class="mb-6 p-4 bg-gray-50 rounded space-y-2"></div>
            
            <div id="financeWorkflowProgress" class="mb-6 hidden">
                <h4 class="font-semibold mb-3">Approval Progress</h4>
                <div id="financeProgressSteps" class="space-y-2"></div>
            </div>
            
            <div id="financeApprovalControls" class="mb-6 hidden">
                <textarea id="financeApprovalComment" placeholder="Comments (optional)" rows="3" class="w-full p-2 border rounded mb-2"></textarea>
                <div class="flex gap-2">
                    <button onclick="window.financeApproveClaim()" class="flex-1 bg-green-600 text-white px-4 py-2 rounded">Approve</button>
                    <button onclick="window.showFinanceRejectForm()" class="flex-1 bg-red-600 text-white px-4 py-2 rounded">Reject</button>
                </div>
            </div>
            
            <div id="financeRejectForm" class="mb-6 hidden">
                <textarea id="financeRejectionReason" placeholder="Reason for rejection *" rows="3" class="w-full p-2 border rounded mb-2" required></textarea>
                <button onclick="window.submitFinanceRejection()" class="w-full bg-red-600 text-white px-4 py-2 rounded">Submit Rejection</button>
            </div>
            
            <button onclick="closeFinanceModal()" class="w-full bg-gray-300 px-4 py-2 rounded">Close</button>
        </div>
    </div>

    <script src="approval-workflow.js"></script>
    <script>
        let financeWorkflow = null;
        let currentFinanceApprovalWF = null;

        // Initialize approval workflow
        try {
            financeWorkflow = new ApprovalWorkflow({
                moduleName: 'Finance',
                steps: [
                    { stepId: 'finance-officer-review', role: 'Finance Officer', department: 'Finance' },
                    { stepId: 'head-of-finance-review', role: 'Head of Finance', department: 'Finance' },
                    { stepId: 'teller-review', role: 'Teller', department: 'Branch' },
                    { stepId: 'marks-disbursed', role: 'Teller', department: 'Branch' }
                ]
            });
            console.log('[INIT] Finance workflow initialized with 4 approval steps');
        } catch (e) {
            console.error('[ERROR] Failed to initialize workflow:', e);
        }

        // Show Claim Modal
        window.showFinanceClaimModal = function(claimId, workflowId) {
            try {
                console.log('[MODAL] Opening claim:', claimId);
                const workflows = JSON.parse(localStorage.getItem('approvalWorkflows')||'[]');
                const wf = workflows.find(w => w.id === workflowId || w.requestId === claimId);
                
                if (!wf) {
                    alert('Claim not found');
                    return;
                }
                
                currentFinanceApprovalWF = wf;
                
                const claimDetails = wf.data || {};
                const claimDetailsEl = document.getElementById('financeClaimDetails');
                if (claimDetailsEl) {
                    claimDetailsEl.innerHTML = `
                        <p><strong>ID:</strong> ${wf.id || claimId}</p>
                        <p><strong>Claimant:</strong> ${wf.claimant || claimDetails.claimant || '-'}</p>
                        <p><strong>Amount:</strong> KSH ${parseFloat(claimDetails.amount || 0).toLocaleString('en-KE', {minimumFractionDigits: 2})}</p>
                        <p><strong>Type:</strong> ${claimDetails.type || '-'}</p>
                        <p><strong>Status:</strong> ${wf.status}</p>
                    `;
                }
                
                // Show approval controls if this user needs to approve
                const userRole = localStorage.getItem('financeUserRole');
                const currentStep = wf.steps?.[wf.currentStep];
                if (currentStep && currentStep.role === userRole && currentStep.status === 'pending') {
                    document.getElementById('financeApprovalControls').classList.remove('hidden');
                } else {
                    document.getElementById('financeApprovalControls').classList.add('hidden');
                }
                
                document.getElementById('financeApprovalModal').classList.remove('hidden');
            } catch(e) {
                console.error('[MODAL] Error:', e);
                alert('Error opening claim: ' + e.message);
            }
        };

        // Restore session on page load
        window.addEventListener('load', function() {
            const financeUserName = localStorage.getItem('financeUserName');
            const financeUserEmail = localStorage.getItem('financeUserEmail');
            const financeUserRole = localStorage.getItem('financeUserRole');

            if (financeUserName && financeUserEmail && financeUserRole) {
                // User is already logged in, skip login screen
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('financePortal').classList.remove('hidden');
                const financeUserDisplayEl = document.getElementById('financeUserDisplay');
                if (financeUserDisplayEl) financeUserDisplayEl.textContent = financeUserName;
                const financeRoleDisplayEl = document.getElementById('financeRoleDisplay');
                if (financeRoleDisplayEl) financeRoleDisplayEl.textContent = financeUserRole;

                // Initialize workflow
                const claimWorkflowConfig = {
                    moduleName: 'expense',
                    steps: [
                        { stepId: 'finance-officer-review', role: 'Finance Officer', department: 'Finance', approver: 'Finance Officer' },
                        { stepId: 'head-of-finance-review', role: 'Head of Finance', department: 'Finance', approver: 'Head of Finance' }
                    ]
                };
                try { financeWorkflow = new ApprovalWorkflow(claimWorkflowConfig); } catch (_) { console.warn('ApprovalWorkflow not available'); }

                loadFinanceDashboard();
            }
        });

        // Auto-create demo users if none exist
        if(!localStorage.getItem('financeUsers')) {
            const demoUsers = [
                {
                    name: 'John Finance Officer',
                    email: 'john.finance@onit.local',
                    role: 'Finance Officer',
                    department: 'Finance',
                    password: '1234',
                    createdAt: new Date().toISOString()
                },
                {
                    name: 'Sarah Head of Finance',
                    email: 'sarah.hof@onit.local',
                    role: 'Head of Finance',
                    department: 'Finance',
                    password: '1234',
                    createdAt: new Date().toISOString()
                }
            ];
            localStorage.setItem('financeUsers', JSON.stringify(demoUsers));
        }

                function loadFinanceDashboard() {
                    // Get user data
                    const userEmail = localStorage.getItem('financeUserEmail') || '';
                    const userRole = localStorage.getItem('financeUserRole') || '';
            
                    // Get employees and find current user's leave balance
                    const employees = JSON.parse(localStorage.getItem('employees') || '[]');
                    const currentUser = employees.find(e => e.email === userEmail);
                    const leaveBalance = currentUser?.leaveBalances || { Annual: 0, Sick: 0, Personal: 0 };
                    const totalLeave = leaveBalance.Annual + leaveBalance.Sick + leaveBalance.Personal;
            
                    // Get claims awaiting THIS user's approval (current step matches their role)
                    const allWorkflows = JSON.parse(localStorage.getItem('approvalWorkflows') || '[]');
                    const pendingForReview = allWorkflows.filter(wf => {
                        if(wf.status !== 'in-progress' && wf.status !== 'pending') return false;
                        const currentStep = wf.steps[wf.currentStep];
                        return currentStep && currentStep.role === userRole && currentStep.status === 'pending';
                    }).length;
                    
                    // Get claims approved by THIS user this month
                    const approvedThisMonth = allWorkflows.filter(wf => {
                        const createdDate = new Date(wf.createdAt);
                        const isThisMonth = createdDate.getMonth() === new Date().getMonth() && 
                                          createdDate.getFullYear() === new Date().getFullYear();
                        return wf.status === 'approved' && isThisMonth;
                    }).length;
            
                    // Get user's personal claims
                    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
                    const userClaims = claims.filter(c => c.email === userEmail);
                    const totalClaims = userClaims.length;
                    const userPending = userClaims.filter(c => c.status === 'Pending').length;
                    const userApproved = userClaims.filter(c => c.status === 'Approved').length;
                    const userRejected = userClaims.filter(c => c.status === 'Rejected').length;
            
                    // Dashboard claims management removed - only shown in Manage Claims section
            
                    // Recent activity
                    const activities = [];
                    userClaims.slice(-4).reverse().forEach(c => {
                        activities.push(`üíº ${c.type}: KSH ${parseFloat(c.amount).toLocaleString('en-KE', {minimumFractionDigits: 2})} - ${c.status}`);
                    });
            
                    const activityDiv = document.getElementById('dashboardFinanceActivity');
                    if (activityDiv) {
                        if (activities.length > 0) {
                            activityDiv.innerHTML = activities.map(a => `<p class="text-sm text-gray-700 p-2 bg-gray-50 rounded">${a}</p>`).join('');
                        } else {
                            activityDiv.innerHTML = '<p class="text-gray-500 text-center py-6">No recent activity</p>';
                        }
                    }
                }

        // Load available finance users into the dropdown
        (async function loadFinanceUsersDropdown(){
            try{
                const resp = await fetch('/api/users');
                if(!resp || resp.status!==200) return;
                const data = await resp.json();
                let users = data.users || [];
                users = users.filter(u => (u.department||'').toLowerCase() === 'finance');
                const emailSel = document.getElementById('financeUserEmail');
                if(!emailSel) return;
                emailSel.innerHTML = '<option value="">Select Email</option>';
                users.forEach(u=>{
                    const opt = document.createElement('option');
                    opt.value = u.email;
                    opt.textContent = u.email;
                    opt.dataset.role = u.role || '';
                    emailSel.appendChild(opt);
                });
            }catch(e){ console.warn('loadFinanceUsersDropdown failed', e); }
        })();

        (async function loadFinanceUsers(){
            try{
                const resp = await fetch('/api/users');
                if(!resp || resp.status!==200) return;
                const data = await resp.json();
                let users = data.users || data || [];
                // Only finance department
                users = users.filter(u => (u.department||'').toLowerCase() === 'finance');
                const emailSel = document.getElementById('financeUserEmail');
                if(!emailSel) return;
                emailSel.innerHTML = '<option value="">Select Email</option>';
                users.forEach(u=>{
                    const opt = document.createElement('option');
                    opt.value = u.email;
                    opt.textContent = u.email;
                    opt.dataset.role = u.role || '';
                    emailSel.appendChild(opt);
                });
            }catch(e){ console.warn('loadFinanceUsers failed', e); }
        })();

        window.financeApproveClaim = function() {
            try {
                const userRole = localStorage.getItem('financeUserRole') || '';
                
                // Role-based access control: Only Finance Officer and Head of Finance can approve
                const approvalRoles = ['Finance Officer', 'Head of Finance'];
                if (!approvalRoles.includes(userRole)) {
                    alert('Access Denied: Only Finance Officer or Head of Finance can approve claims. Your role: ' + userRole);
                    return;
                }
                
                const comment = document.getElementById('financeApprovalComment').value;
                const userDept = localStorage.getItem('financeUserDept') || 'Finance';
                const userEmail = localStorage.getItem('financeUserEmail');
                const userName = localStorage.getItem('financeUserName') || 'Finance Officer';
                
                financeWorkflow.approveStep(currentFinanceApprovalWF.id, userEmail, userRole, userDept, comment);
                
                // Reload the workflow to get updated values
                const workflows = JSON.parse(localStorage.getItem('approvalWorkflows')||'[]');
                const updatedWF = workflows.find(w => w.id === currentFinanceApprovalWF.id);
                if (updatedWF) {
                    currentFinanceApprovalWF = updatedWF;
                }
                
                // Try to find and update claim in expenseClaims first, then in generic claims
                let claim = null;
                const expenseClaims = JSON.parse(localStorage.getItem('expenseClaims')||'[]');
                claim = expenseClaims.find(c => c.id === currentFinanceApprovalWF.requestId);
                
                if(!claim) {
                    // Try generic claims storage (from Branch/ICT)
                    const genericClaims = JSON.parse(localStorage.getItem('claims')||'[]');
                    claim = genericClaims.find(c => c.id === currentFinanceApprovalWF.requestId);
                    
                    if(claim) {
                        // Update in generic claims
                        if(currentFinanceApprovalWF.currentStep === 0) {
                            claim.status = 'Pending';
                        } else if(currentFinanceApprovalWF.currentStep === 1) {
                            claim.status = 'Pending';
                        } else if(currentFinanceApprovalWF.currentStep >= currentFinanceApprovalWF.steps.length) {
                            claim.status = 'APPROVED';
                        }
                        localStorage.setItem('claims', JSON.stringify(genericClaims));
                    }
                }
                
                // If found in expenseClaims, update there
                if(claim && expenseClaims.find(c => c.id === claim.id)) {
                    if(currentFinanceApprovalWF.currentStep >= currentFinanceApprovalWF.steps.length) {
                        claim.status = 'APPROVED';
                    } else {
                        claim.status = 'Pending';
                    }
                    localStorage.setItem('expenseClaims', JSON.stringify(expenseClaims));
                }
                
                // Create disbursement when workflow is fully approved (all steps completed)
                if(claim && currentFinanceApprovalWF.status === 'approved') {
                    const disbursements = JSON.parse(localStorage.getItem('claimDisbursements') || '[]');
                    const disbursement = {
                        id: 'DISB-' + Date.now(),
                        claimId: claim.id || currentFinanceApprovalWF.requestId,
                        claimant: claim.claimant || claim.name || '',
                        email: claim.email,
                        amount: claim.amount,
                        claimType: claim.type,
                        approvedDate: new Date().toISOString(),
                        approvedBy: userEmail,
                        status: 'pending'
                    };
                    disbursements.push(disbursement);
                    localStorage.setItem('claimDisbursements', JSON.stringify(disbursements));
                }
                
                // Save to approval audit log
                const auditLogs = JSON.parse(localStorage.getItem('approvalAuditLogs') || '[]');
                const currentStep = currentFinanceApprovalWF.steps[currentFinanceApprovalWF.currentStep - 1] || currentFinanceApprovalWF.steps[0];
                auditLogs.push({
                    id: 'LOG-' + Date.now(),
                    requestId: currentFinanceApprovalWF.requestId,
                    claimId: currentFinanceApprovalWF.requestId,
                    amount: claim?.amount || 0,
                    type: claim?.type || 'Expense',
                    action: 'STEP_APPROVED',
                    step: currentStep?.stepId || 'unknown',
                    actor: userEmail,
                    actorName: userName,
                    details: `Approved by ${userRole} - ${currentStep?.stepId || 'step'}`,
                    comment: comment,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('approvalAuditLogs', JSON.stringify(auditLogs));
                
                const stepName = currentStep?.stepId === 'finance-officer-review' ? 'Finance Officer' : 'Head of Finance';
                const isFullyApproved = currentFinanceApprovalWF.status === 'approved';
                const nextAction = isFullyApproved ? 'fully approved and moved to disbursement' : 'sent to next approver';
                alert(`Claim approved by ${stepName}! Claim has been ${nextAction}.`);
                closeFinanceModal();
                loadFinanceClaims();
            } catch(e) {
                alert('Error: ' + e.message);
                console.error(e);
            }
        }

        window.showFinanceRejectForm = function() {
            document.getElementById('financeRejectForm').classList.remove('hidden');
        };

        window.submitFinanceRejection = function() {
            const userRole = localStorage.getItem('financeUserRole') || '';
            
            // Role-based access control: Only Finance Officer and Head of Finance can reject
            const approvalRoles = ['Finance Officer', 'Head of Finance'];
            if (!approvalRoles.includes(userRole)) {
                alert('Access Denied: Only Finance Officer or Head of Finance can reject claims. Your role: ' + userRole);
                return;
            }
            
            const reason = document.getElementById('financeRejectionReason').value.trim();
            if(!reason) {
                alert('Please provide a rejection reason');
                return;
            }
            try {
                const userRole = localStorage.getItem('financeUserRole') || '';
                const userDept = localStorage.getItem('financeUserDept') || 'Finance';
                const userEmail = localStorage.getItem('financeUserEmail');
                const userName = localStorage.getItem('financeUserName') || 'Finance Officer';
                
                financeWorkflow.rejectStep(currentFinanceApprovalWF.id, userEmail, userRole, userDept, reason);
                
                // Update claim status in both storages
                let claim = null;
                const expenseClaims = JSON.parse(localStorage.getItem('expenseClaims')||'[]');
                const expenseClaim = expenseClaims.find(c => c.id === currentFinanceApprovalWF.requestId);
                if(expenseClaim) {
                    expenseClaim.status = 'REJECTED';
                    claim = expenseClaim;
                    localStorage.setItem('expenseClaims', JSON.stringify(expenseClaims));
                }
                
                const genericClaims = JSON.parse(localStorage.getItem('claims')||'[]');
                const genericClaim = genericClaims.find(c => c.id === currentFinanceApprovalWF.requestId);
                if(genericClaim) {
                    genericClaim.status = 'Rejected';
                    genericClaim.rejectionReason = reason;
                    if(!claim) claim = genericClaim;
                    localStorage.setItem('claims', JSON.stringify(genericClaims));
                }
                
                // Update workflow status
                const workflows = JSON.parse(localStorage.getItem('approvalWorkflows')||'[]');
                const wf = workflows.find(w => w.id === currentFinanceApprovalWF.id);
                if(wf) {
                    wf.status = 'rejected';
                    localStorage.setItem('approvalWorkflows', JSON.stringify(workflows));
                }
                
                // Save to approval audit log
                const auditLogs = JSON.parse(localStorage.getItem('approvalAuditLogs') || '[]');
                auditLogs.push({
                    id: 'LOG-' + Date.now(),
                    requestId: currentFinanceApprovalWF.requestId,
                    claimId: currentFinanceApprovalWF.requestId,
                    amount: claim?.amount || 0,
                    type: claim?.type || 'Expense',
                    action: 'STEP_REJECTED',
                    step: 'rejection',
                    actor: userEmail,
                    actorName: userName,
                    details: `Rejected by ${userRole} - Reason: ${reason}`,
                    comment: reason,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('approvalAuditLogs', JSON.stringify(auditLogs));
                
                // Notify the claimant
                const claimEmail = expenseClaim?.email || genericClaim?.email;
                if(claimEmail) {
                    const notifications = JSON.parse(localStorage.getItem('userNotifications') || '[]');
                    notifications.push({
                        id: 'NOTIF-' + Date.now(),
                        userEmail: claimEmail,
                        claimId: currentFinanceApprovalWF.requestId,
                        message: `Your claim #${currentFinanceApprovalWF.requestId} has been rejected by ${userName}.\nReason: ${reason}`,
                        type: 'claim_rejected',
                        createdAt: new Date().toISOString(),
                        read: false
                    });
                    localStorage.setItem('userNotifications', JSON.stringify(notifications));
                }
                
                alert('Claim rejected: ' + reason + '\n\nUser will be notified.');
                closeFinanceModal();
                loadFinanceClaims();
            } catch(e) {
                alert('Error: ' + e.message);
                console.error(e);
            }
        };

        function loadApprovalHistory() {
            const userRole = localStorage.getItem('financeUserRole') || '';
            const allWorkflows = JSON.parse(localStorage.getItem('approvalWorkflows')||'[]');
            
            // Get workflows where user has approved a step
            const auditLogs = JSON.parse(localStorage.getItem('approvalAuditLogs')||'[]');
            const userApprovals = auditLogs.filter(log => 
                log.actor === localStorage.getItem('financeUserEmail') && 
                log.action === 'STEP_APPROVED'
            );
            
            const container = document.getElementById('approvalHistoryList');
            
            if(userApprovals.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No approval history</p>';
                return;
            }
            
            container.innerHTML = userApprovals.map(log => {
                const wf = allWorkflows.find(w => w.requestId === log.requestId);
                const claimAmount = wf ? wf.data.amount : 'N/A';
                return `<div class="bg-white p-4 rounded shadow border-l-4 border-green-500">
                    <p><strong>Claim ID:</strong> ${log.requestId}</p>
                    <p><strong>Amount:</strong> KSH ${parseFloat(claimAmount).toLocaleString('en-KE', {minimumFractionDigits: 2})}</p>
                    <p><strong>Step:</strong> ${log.details}</p>
                    <p><strong>Date:</strong> ${new Date(log.timestamp).toLocaleString()}</p>
                </div>`;
            }).join('');
        }

        function closeFinanceModal() {
            document.getElementById('financeApprovalModal').classList.add('hidden');
        }

        // Refresh user's role from server
        window.refreshUserRole = function() {
            const userEmail = localStorage.getItem('financeUserEmail');
            if (!userEmail) return;
            
            fetch('/api/users').then(r => r.json()).then(data => {
                if (data.success && Array.isArray(data.users)) {
                    const user = data.users.find(u => u.email === userEmail);
                    if (user && user.role) {
                        const oldRole = localStorage.getItem('financeUserRole');
                        localStorage.setItem('financeUserRole', user.role);
                        if (oldRole !== user.role) {
                            document.getElementById('financeRoleDisplay').textContent = user.role;
                            console.log('[ROLE] Updated from', oldRole, 'to', user.role);
                        }
                    }
                }
            }).catch(e => console.warn('Failed to refresh role:', e));
        };

        // Check role every 30 seconds for active users
        setInterval(() => {
            if (localStorage.getItem('financeUserRole')) {
                refreshUserRole();
            }
        }, 30000);

        // --- Expense Claims Functions ---
        window.showNewClaimForm = function(){ 
            document.getElementById('claimName').value = localStorage.getItem('financeUserName')||'';
            document.getElementById('claimEmail').value = localStorage.getItem('financeUserEmail')||'';
            document.getElementById('newClaimForm').classList.remove('hidden'); 
        }
        window.hideNewClaimForm = function(){ document.getElementById('newClaimForm').classList.add('hidden'); }

window.loadClaims = function(){ 
            const claims = JSON.parse(localStorage.getItem('claims')||'[]'); 
            const userEmail = localStorage.getItem('financeUserEmail')||localStorage.getItem('userEmail'); 
            // My Expense Claims - only show claims submitted by the logged-in user
            const filtered = claims.filter(c => c.email === userEmail); 
            const tbody = document.getElementById('claimsList'); 
            if(filtered.length===0){ tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center">No claims</td></tr>'; return; } 
            tbody.innerHTML = filtered.map(c=>`<tr><td class="p-2">${c.id}</td><td class="p-2">${c.name||''}</td><td class="p-2">${c.email||''}</td><td class="p-2">${c.type}</td><td class="p-2">KSH ${parseFloat(c.amount).toLocaleString('en-KE', {minimumFractionDigits: 2})}</td><td class="p-2">${c.date||''}</td><td class="p-2">${c.status}</td></tr>`).join(''); 
        }

        // Prevent duplicate event listeners - only attach once
        if (!window.claimFormListenerAttached) {
            window.claimFormListenerAttached = true;
            
            document.getElementById('claimFormEl').addEventListener('submit', function(e){
                e.preventDefault();
                const nextIds = JSON.parse(localStorage.getItem('claimNextId') || '{"id": 1}');
                const id = String(nextIds.id);
                nextIds.id++;
                localStorage.setItem('claimNextId', JSON.stringify(nextIds));
                const type = document.getElementById('claimType').value;
                const amount = parseFloat(document.getElementById('claimAmount').value)||0;
                const date = document.getElementById('claimDate').value;
                const receiptInput = document.getElementById('claimReceipt');
                const receiptName = receiptInput && receiptInput.files && receiptInput.files[0] ? receiptInput.files[0].name : null;
                const desc = document.getElementById('claimDescription').value||'';
                if(amount <= 0){ alert('Enter a valid amount'); return; }
                
                const claimName = localStorage.getItem('financeUserName')||'';
                const claimEmail = localStorage.getItem('financeUserEmail')||'';
                
                const claim = { id, name: claimName, email: claimEmail, type, amount, date, receipt: receiptName, description: desc, status: 'Pending', approverDept: 'Finance', timestamp: new Date().toISOString() };
                const claims = JSON.parse(localStorage.getItem('claims')||'[]');
                
                // Prevent duplicates - check if this exact claim already exists
                const isDuplicate = claims.some(c => c.id === id && c.email === claimEmail && c.timestamp === claim.timestamp);
                if(isDuplicate) {
                    console.warn('[CLAIMS] Duplicate submission prevented for claim:', id);
                    return;
                }
                
                claims.push(claim); 
                localStorage.setItem('claims', JSON.stringify(claims));
                
                window.hideNewClaimForm(); 
                this.reset(); 
                window.loadClaims();
                alert('‚úÖ Claim submitted: #' + id + ' (KSH ' + parseFloat(amount).toLocaleString('en-KE', {minimumFractionDigits: 2}) + ')');
            });
        }

        // --- Leave Management Functions ---
        const PUBLIC_HOLIDAYS = ['2026-01-01'];
        function isPublicHoliday(dateStr) { return PUBLIC_HOLIDAYS.includes(dateStr); }
        function formatDateISO(d) { const yyyy = d.getFullYear(); const mm = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}`; }
        function calculateLeaveDays() {
            const startVal = document.getElementById('leaveStartDate').value;
            const endVal = document.getElementById('leaveEndDate').value;
            const daysEl = document.getElementById('leaveDays');
            if (!startVal || !endVal) { if(daysEl) daysEl.value = 0; return 0; }
            const start = new Date(startVal + 'T00:00:00');
            const end = new Date(endVal + 'T00:00:00');
            if (end < start) { if(daysEl) daysEl.value = 0; return 0; }
            let count = 0;
            for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
                const day = d.getDay(); if (day === 0 || day === 6) continue; const iso = formatDateISO(d); if (isPublicHoliday(iso)) continue; count++; }
            if(daysEl) daysEl.value = count; return count;
        }
        try { document.getElementById('leaveStartDate').addEventListener('change', calculateLeaveDays); } catch(e){}
        try { document.getElementById('leaveEndDate').addEventListener('change', calculateLeaveDays); } catch(e){}
        window.showNewLeaveForm = function(){ try{ document.getElementById('leaveName').value = localStorage.getItem('financeUserName')||'';}catch(e){} try{ document.getElementById('leaveEmail').value = localStorage.getItem('financeUserEmail')||'';}catch(e){} document.getElementById('newLeaveForm').classList.remove('hidden'); window.updateLeaveTypeBalanceDisplay(); }
        window.hideNewLeaveForm = function(){ document.getElementById('newLeaveForm').classList.add('hidden'); }
        window.loadLeaveRequests = function(){ const reqs = JSON.parse(localStorage.getItem('leaveRequests')||'[]'); const isAdmin = localStorage.getItem('isAdmin')==='true'; const userEmail = localStorage.getItem('financeUserEmail')||localStorage.getItem('userEmail'); const filtered = isAdmin ? reqs : reqs.filter(r => (r.email||'') === (userEmail||'')); const tbody = document.getElementById('leaveList'); if(!tbody) return; if(filtered.length===0){ tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center">No leave requests</td></tr>'; return; } tbody.innerHTML = filtered.map(r=>`<tr><td class="p-2">${r.id}</td><td class="p-2">${r.name||''}</td><td class="p-2">${r.email||''}</td><td class="p-2">${r.type}</td><td class="p-2">${r.startDate||''}</td><td class="p-2">${r.endDate||''}</td><td class="p-2">${r.resumeDate||''}</td><td class="p-2">${r.days}</td><td class="p-2">${r.status}</td></tr>`).join(''); }
        document.addEventListener('submit', function(e){ if(e.target && e.target.id==='leaveFormEl'){ e.preventDefault(); const id = window.getNextId('leaveRequests'); const start = document.getElementById('leaveStartDate').value; const end = document.getElementById('leaveEndDate').value; const resume = document.getElementById('leaveResumeDate').value; const daysCalculated = calculateLeaveDays(); if(daysCalculated<=0){ alert('Invalid leave range or zero working days selected.'); return; } const req = { id, name: localStorage.getItem('financeUserName')||'', email: localStorage.getItem('financeUserEmail')||localStorage.getItem('userEmail'), type: document.getElementById('leaveType').value, days: daysCalculated, startDate: start, endDate: end, resumeDate: resume, reason: document.getElementById('leaveReason').value||'', status: 'Pending', approverDept: 'Admin', timestamp: new Date().toISOString() }; const reqs = JSON.parse(localStorage.getItem('leaveRequests')||'[]'); reqs.push(req); localStorage.setItem('leaveRequests', JSON.stringify(reqs)); window.hideNewLeaveForm(); e.target.reset(); window.loadLeaveRequests(); alert('Leave request submitted: '+id); } });
        window.updateLeaveTypeBalanceDisplay = function(){ const type = (document.getElementById('leaveType').value||'').toLowerCase(); const email = (localStorage.getItem('financeUserEmail')||localStorage.getItem('userEmail')||'').toLowerCase(); const employees = JSON.parse(localStorage.getItem('employees')||'[]'); const u = employees.find(e=> (e.email||'').toLowerCase()===email); let val = 0; if(u && u.leaveBalances){ if(type==='annual') val = u.leaveBalances.annual||0; else if(type==='sick') val = u.leaveBalances.sick||0; else if(type==='personal') val = u.leaveBalances.personal||0; } let helper = document.getElementById('leaveTypeHelper'); if(!helper){ helper = document.createElement('p'); helper.id = 'leaveTypeHelper'; helper.className = 'text-xs text-gray-500 mt-1'; document.getElementById('leaveType').parentNode.appendChild(helper); } helper.textContent = 'Available balance: ' + val + ' days'; }
        window.getNextId = function(key){ const next = JSON.parse(localStorage.getItem('nextIds') || '{}'); if(!next[key]) next[key]=1; const id = next[key]++; localStorage.setItem('nextIds', JSON.stringify(next)); return String(id); }
        try{ document.getElementById('leaveType').addEventListener('change', window.updateLeaveTypeBalanceDisplay); } catch(e){}

        function loadFinanceTickets() {
            const userEmail = localStorage.getItem('financeUserEmail');
            const allTickets = JSON.parse(localStorage.getItem('tickets') || '[]');
            const financeTickets = allTickets.filter(t => (t.department || '').toLowerCase() === 'finance');
            const tbody = document.getElementById('financeTicketsList');
            
            if (financeTickets.length === 0) {
                tbody.innerHTML = '<tr><td class="p-4 text-center" colspan="7">No tickets</td></tr>';
                return;
            }
            
            tbody.innerHTML = financeTickets.map(t => `
                <tr class="hover:bg-gray-50">
                    <td class="p-3">${t.id}</td>
                    <td class="p-3">${t.subject || ''}</td>
                    <td class="p-3">${t.type || ''}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded text-xs font-semibold ${t.priority === 'High' ? 'bg-red-100 text-red-800' : t.priority === 'Critical' ? 'bg-red-200 text-red-900' : 'bg-gray-100 text-gray-800'}">${t.priority || 'Low'}</span></td>
                    <td class="p-3">${t.createdDate || (t.timestamp ? t.timestamp.split('T')[0] : '')}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded text-xs font-semibold ${t.status === 'Open' ? 'bg-yellow-100 text-yellow-800' : t.status === 'Closed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${t.status}</span></td>
                    <td class="p-3">
                        <div class="flex items-center gap-2">
                            <button onclick="viewTicketDetails('${t.id}')" class="text-blue-600 hover:underline text-sm">View</button>
                            <button onclick="financeTicketAction('${t.id}','resolve')" class="text-yellow-600 hover:underline text-sm">Resolve</button>
                            <button onclick="financeTicketAction('${t.id}','close')" class="text-green-600 hover:underline text-sm">Close</button>
                            <button onclick="financeCommentTicket('${t.id}')" class="text-gray-600 hover:underline text-sm">Comment</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function pushSentEmail(to, subject, body){ const sent = JSON.parse(localStorage.getItem('sentEmails')||'[]'); sent.push({to,subject,body,sentAt:new Date().toISOString()}); localStorage.setItem('sentEmails', JSON.stringify(sent)); }

        function financeTicketAction(ticketId, action){
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            const employees = JSON.parse(localStorage.getItem('employees')||'[]');
            const t = tickets.find(x=>x.id===ticketId);
            if(!t){ alert('Ticket not found'); return; }
            const actorId = localStorage.getItem('financeUserEmail') || localStorage.getItem('financeUserName') || 'Finance-User';
            const actorName = localStorage.getItem('financeUserName') || actorId;
            if(action==='resolve'){
                t.status = 'Resolved'; t.resolvedAt = new Date().toISOString(); t.resolvedBy = actorId; t.resolvedByName = actorName;
            } else if(action==='close'){
                t.status = 'Closed'; t.closedAt = new Date().toISOString(); t.closedBy = actorId; t.closedByName = actorName;
            } else if(action==='progress'){
                t.status = 'In Progress';
            }
            t.history = t.history||[]; t.history.push({ action: action, by: actorId, byName: actorName, at: new Date().toISOString(), notes: '' });
            localStorage.setItem('tickets', JSON.stringify(tickets));
            try{ pushSentEmail(t.email, `Your ticket ${t.id} ${t.status}`, 'Ticket updated by finance'); }catch(e){}
            loadFinanceTickets();
        }

        function financeCommentTicket(ticketId){
            const note = prompt('Add comment:'); if(!note) return;
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            const t = tickets.find(x=>x.id===ticketId); if(!t){ alert('Ticket not found'); return; }
            const actorId = localStorage.getItem('financeUserEmail') || localStorage.getItem('financeUserName') || 'Finance-User';
            const actorName = localStorage.getItem('financeUserName') || actorId;
            t.history = t.history||[]; t.history.push({ action: 'comment', by: actorId, byName: actorName, at: new Date().toISOString(), notes: note });
            localStorage.setItem('tickets', JSON.stringify(tickets));
            try{ pushSentEmail(t.email, `New comment on ticket ${t.id}`, note); }catch(e){}
            loadFinanceTickets();
        }

        // Detailed ticket view for Finance portal
        function viewTicketDetails(ticketId){
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            const t = tickets.find(x=>x.id===ticketId);
            if(!t){ alert('Ticket not found'); return; }

            let modal = document.getElementById('financeTicketModal');
            if(!modal){
                modal = document.createElement('div');
                modal.id = 'financeTicketModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="sticky top-0 bg-gray-800 text-white p-6 flex justify-between items-center">
                            <h2 class="text-2xl font-bold">Ticket Details</h2>
                            <button onclick="document.getElementById('financeTicketModal').style.display='none'" class="text-2xl hover:text-gray-300">√ó</button>
                        </div>
                        <div id="financeTicketContent" class="p-6"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('financeTicketContent').innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-gray-500 text-sm">Ticket ID</p>
                            <p class="text-xl font-bold text-gray-800">${t.id}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Status</p>
                            <p class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${t.status === 'Open' ? 'bg-yellow-100 text-yellow-800' : t.status === 'Closed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${t.status}</p>
                        </div>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Subject</p>
                        <p class="text-lg font-semibold text-gray-800">${t.subject||'N/A'}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-gray-500 text-sm">Priority</p>
                            <p class="inline-block px-3 py-1 rounded text-sm font-semibold ${t.priority === 'High' ? 'bg-red-100 text-red-800' : t.priority === 'Critical' ? 'bg-red-200 text-red-900' : 'bg-gray-100 text-gray-800'}">${t.priority||'Low'}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm">Created Date</p>
                            <p class="text-gray-800">${t.createdDate || (t.timestamp ? new Date(t.timestamp).toLocaleDateString() : '')}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded border border-blue-200">
                            <p class="text-gray-500 text-sm font-semibold">Created By</p>
                            <p class="font-semibold text-gray-800">${t.created_by || t.name || 'Unknown'}</p>
                            <p class="text-sm text-gray-600">${t.created_by_email || t.email || ''}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded border border-green-200">
                            <p class="text-gray-500 text-sm font-semibold">Assigned To</p>
                            <p class="font-semibold text-gray-800">${t.assigned_to || 'Unassigned'}</p>
                        </div>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm mb-2">Description</p>
                        <div class="bg-gray-50 p-4 rounded border border-gray-200"><p class="text-gray-800 whitespace-pre-wrap">${t.description||'No description provided'}</p></div>
                    </div>
                    ${t.resolutionNotes ? `<div><p class="text-gray-500 text-sm mb-2">Resolution Notes</p><div class="bg-yellow-50 p-4 rounded border border-yellow-200"><p class="text-gray-800 whitespace-pre-wrap">${t.resolutionNotes}</p></div></div>` : ''}
                    <div class="mt-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Activity History</h3>
                        ${(t.history||[]).map(h=>`<div class="bg-gray-50 p-3 rounded border-l-4 border-blue-500 mb-2"><p class="font-semibold">${h.action}</p><p class="text-sm text-gray-600">By: ${h.byName || ''}</p>${h.notes?`<p class="text-sm text-gray-700 mt-1"><strong>Notes:</strong> ${h.notes}</p>`:''}<p class="text-xs text-gray-500 mt-1">${h.at?new Date(h.at).toLocaleString():''}</p></div>`).join('')}
                    </div>
                </div>
            `;

            modal.style.display = 'flex';
        }

        
        function getNextId(key){ const next = JSON.parse(localStorage.getItem('nextIds') || '{}'); if(!next[key]) next[key]=1; const id = next[key]++; localStorage.setItem('nextIds', JSON.stringify(next)); return String(id); }
        function showNewLeaveForm(){ try{ document.getElementById('leaveName').value = localStorage.getItem('financeUserName')||'';}catch(e){} try{ document.getElementById('leaveEmail').value = localStorage.getItem('financeUserEmail')||'';}catch(e){} document.getElementById('newLeaveForm').classList.remove('hidden'); updateLeaveTypeBalanceDisplay(); }
        function hideNewLeaveForm(){ document.getElementById('newLeaveForm').classList.add('hidden'); }
        function loadLeaveRequests(){ const reqs = JSON.parse(localStorage.getItem('leaveRequests')||'[]'); const isAdmin = localStorage.getItem('isAdmin')==='true'; const userEmail = localStorage.getItem('financeUserEmail')||localStorage.getItem('userEmail'); const filtered = isAdmin ? reqs : reqs.filter(r => (r.email||'') === (userEmail||'')); const tbody = document.getElementById('leaveList'); if(!tbody) return; if(filtered.length===0){ tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center">No leave requests</td></tr>'; return; } tbody.innerHTML = filtered.map(r=>`<tr><td class="p-2">${r.id}</td><td class="p-2">${r.name||''}</td><td class="p-2">${r.email||''}</td><td class="p-2">${r.type}</td><td class="p-2">${r.startDate||''}</td><td class="p-2">${r.endDate||''}</td><td class="p-2">${r.resumeDate||''}</td><td class="p-2">${r.days}</td><td class="p-2">${r.status}</td></tr>`).join(''); }
        document.addEventListener('submit', function(e){ if(e.target && e.target.id==='leaveFormEl'){ e.preventDefault(); const id = getNextId('leaveRequests'); const start = document.getElementById('leaveStartDate').value; const end = document.getElementById('leaveEndDate').value; const resume = document.getElementById('leaveResumeDate').value; const daysCalculated = calculateLeaveDays(); if(daysCalculated<=0){ alert('Invalid leave range or zero working days selected.'); return; } const req = { id, name: localStorage.getItem('financeUserName')||'', email: localStorage.getItem('financeUserEmail')||localStorage.getItem('userEmail'), type: document.getElementById('leaveType').value, days: daysCalculated, startDate: start, endDate: end, resumeDate: resume, reason: document.getElementById('leaveReason').value||'', status: 'Pending', approverDept: 'Admin', timestamp: new Date().toISOString() }; const reqs = JSON.parse(localStorage.getItem('leaveRequests')||'[]'); reqs.push(req); localStorage.setItem('leaveRequests', JSON.stringify(reqs)); hideNewLeaveForm(); e.target.reset(); loadLeaveRequests(); alert('Leave request submitted: '+id); } });
        function updateLeaveTypeBalanceDisplay(){ const type = (document.getElementById('leaveType').value||'').toLowerCase(); const email = (localStorage.getItem('financeUserEmail')||localStorage.getItem('userEmail')||'').toLowerCase(); const employees = JSON.parse(localStorage.getItem('employees')||'[]'); const u = employees.find(e=> (e.email||'').toLowerCase()===email); let val = 0; if(u && u.leaveBalances){ if(type==='annual') val = u.leaveBalances.annual||0; else if(type==='sick') val = u.leaveBalances.sick||0; else if(type==='personal') val = u.leaveBalances.personal||0; } let helper = document.getElementById('leaveTypeHelper'); if(!helper){ helper = document.createElement('p'); helper.id = 'leaveTypeHelper'; helper.className = 'text-xs text-gray-500 mt-1'; document.getElementById('leaveType').parentNode.appendChild(helper); } helper.textContent = 'Available balance: ' + val + ' days'; }
        try{ document.getElementById('leaveType').addEventListener('change', updateLeaveTypeBalanceDisplay); } catch(e){}

        // Check if already logged in
        window.addEventListener('load', () => {
            if(localStorage.getItem('financeUserRole')) {
                const name = localStorage.getItem('financeUserName');
                const role = localStorage.getItem('financeUserRole');
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('financePortal').classList.remove('hidden');
                const financeDisplayEl = document.getElementById('financeUserDisplay');
                if (financeDisplayEl) financeDisplayEl.textContent = name;
                document.getElementById('financeRoleDisplay').textContent = role;
                
                const claimWorkflowConfig = {
                    moduleName: 'expense',
                    steps: [
                        { stepId: 'finance-officer-review', role: 'Finance Officer', department: 'Finance', approver: 'Finance Officer' },
                        { stepId: 'head-of-finance-review', role: 'Head of Finance', department: 'Finance', approver: 'Head of Finance' }
                    ]
                };
                financeWorkflow = new ApprovalWorkflow(claimWorkflowConfig);
                loadFinanceClaims();
            }
        });
    </script>
</body>
</html>
