
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onit Portal - Dashboard</title>
    <link rel="icon" href="assets/onit-logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sidebar-link { transition: all 0.3s ease; }
        .sidebar-link:hover { background-color: rgba(255,255,255,0.06); transform: translateX(4px); }
        .sidebar-link.active { background-color: rgba(255,255,255,0.08); border-left: 4px solid rgba(255,255,255,0.12); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        :root{
            --bg-1: #0f172a; --accent: #0ea5a3; --card: #ffffff; --muted: #6b7280;
        }
        body{ background: linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%); color:#0f172a; }
        .card{ background:var(--card); border-radius:12px; box-shadow: 0 8px 24px rgba(15,23,42,0.08); padding:1rem; }
        .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem 1rem; border-radius:10px; font-weight:600; cursor:pointer; }
        .btn-primary{ background: linear-gradient(90deg,var(--accent),#059669); color:white; border:none; }
        .btn-secondary{ background:#eef2f7; color:var(--bg-1); border:none; }
        .input{ padding:.5rem .75rem; border-radius:8px; border:1px solid #e6edf3; box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <aside class="w-64 bg-gradient-to-b from-teal-700 to-teal-900 text-white p-6">
            <div class="mb-6 pb-6 border-b border-teal-600 flex items-center gap-3">
                <img src="assets/onit-logo.png" alt="Onit MFB logo" class="w-12 h-12 object-contain">
                <div>
                    <h1 class="text-xl font-bold">Onit</h1>
                    <p class="text-xs text-teal-200">MFB Portal</p>
                </div>
            </div>
            <div class="mb-4 pb-4 border-b border-teal-600">
                <p class="text-sm text-teal-100">Logged in as:</p>
                <p id="userNameDisplay" class="font-semibold">-</p>
                <p id="userTypeDisplay" class="text-xs text-teal-200">-</p>
            </div>
            <nav class="space-y-2">
                <button onclick="switchSection('dashboard')" class="sidebar-link active w-full text-left px-4 py-3 rounded">üìä Dashboard</button>
                <button onclick="switchSection('tickets')" class="sidebar-link w-full text-left px-4 py-3 rounded">üé´ Tickets</button>
                <button onclick="switchSection('leave')" class="sidebar-link w-full text-left px-4 py-3 rounded">üèñÔ∏è Leave Management</button>
                <button onclick="switchSection('finance')" class="sidebar-link w-full text-left px-4 py-3 rounded">üíº Finance</button>
                <button onclick="switchSection('notifications')" class="sidebar-link w-full text-left px-4 py-3 rounded">üîî Notifications <span id="notificationBadge" class="ml-2 px-2 py-0.5 bg-red-500 text-white text-xs rounded-full hidden">0</span></button>
            </nav>
            <div class="mt-8 pt-8 border-t border-teal-600">
                <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded">üö™ Logout</button>
            </div>
        </aside>

        <main class="flex-1 overflow-auto">
            <div id="dashboard" class="content-section active p-8 bg-gradient-to-br from-blue-50 to-indigo-50">
                <!-- Header -->
                <div class="mb-8">
                    <h2 class="text-4xl font-bold text-gray-800 mb-2">Welcome Back</h2>
                    <p class="text-gray-600">Here's your dashboard overview</p>
                </div>

                <!-- User Profile Card -->
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8 border-l-4 border-blue-600">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <p class="text-gray-500 text-sm font-semibold">FULL NAME</p>
                            <p class="text-2xl font-bold text-gray-800 mt-1" id="infoName">-</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm font-semibold">EMAIL</p>
                            <p class="text-lg text-gray-800 mt-1" id="infoEmail">-</p>
                        </div>
                        <div>
                            <p class="text-gray-500 text-sm font-semibold">STATUS</p>
                            <p class="text-lg font-semibold mt-1"><span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm" id="infoType">-</span></p>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <!-- Tickets Card -->
                    <div class="bg-white rounded-lg shadow-md p-6 border-t-4 border-blue-500 hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Total Tickets</p>
                                <p class="text-3xl font-bold text-blue-600 mt-2" id="totalTickets">0</p>
                            </div>
                            <div class="text-5xl text-blue-200">üé´</div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">Open: <span class="font-semibold text-blue-600" id="openTickets">0</span></p>
                    </div>

                    <!-- Claims Card -->
                    <div class="bg-white rounded-lg shadow-md p-6 border-t-4 border-green-500 hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Total Claims</p>
                                <p class="text-3xl font-bold text-green-600 mt-2" id="totalClaims">0</p>
                            </div>
                            <div class="text-5xl text-green-200">üíº</div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">Pending: <span class="font-semibold text-green-600" id="pendingClaims">0</span></p>
                    </div>

                    <!-- Leave Requests Card -->
                    <div class="bg-white rounded-lg shadow-md p-6 border-t-4 border-purple-500 hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Leave Requests</p>
                                <p class="text-3xl font-bold text-purple-600 mt-2" id="totalLeave">0</p>
                            </div>
                            <div class="text-5xl text-purple-200">üèñÔ∏è</div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">Pending: <span class="font-semibold text-purple-600" id="pendingLeave">0</span></p>
                    </div>

                    <!-- Notifications Card -->
                    <div class="bg-white rounded-lg shadow-md p-6 border-t-4 border-orange-500 hover:shadow-lg transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Notifications</p>
                                <p class="text-3xl font-bold text-orange-600 mt-2" id="totalNotifications">0</p>
                            </div>
                            <div class="text-5xl text-orange-200">üîî</div>
                        </div>
                        <p class="text-xs text-gray-400 mt-3">Unread: <span class="font-semibold text-orange-600" id="unreadNotifications">0</span></p>
                    </div>
                </div>

                <!-- Leave Balances -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Leave Balance</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <p class="text-gray-600 text-sm font-semibold">Annual Leave</p>
                            <p class="text-3xl font-bold text-blue-600 mt-2" id="balAnnual">0</p>
                            <p class="text-xs text-gray-500 mt-1">days remaining</p>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg border border-red-200">
                            <p class="text-gray-600 text-sm font-semibold">Sick Leave</p>
                            <p class="text-3xl font-bold text-red-600 mt-2" id="balSick">0</p>
                            <p class="text-xs text-gray-500 mt-1">days remaining</p>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <p class="text-gray-600 text-sm font-semibold">Personal Leave</p>
                            <p class="text-3xl font-bold text-yellow-600 mt-2" id="balPersonal">0</p>
                            <p class="text-xs text-gray-500 mt-1">days remaining</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Activity</h3>
                    <div id="recentActivityContainer" class="space-y-3">
                        <p class="text-gray-500 text-center py-8">No recent activity</p>
                    </div>
                </div>

            </div>

            <div id="tickets" class="content-section p-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Tickets</h2>
                    <button onclick="showNewTicketForm()" class="btn btn-primary">+ New Ticket</button>
                </div>
                <div id="newTicketForm" class="hidden card mb-4">
                    <h3 class="font-semibold mb-4">Submit New Ticket</h3>
                    <form id="ticketFormEl" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Subject</label>
                                <input id="ticketSubject" placeholder="Short title" required class="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Type</label>
                                <select id="ticketType" class="w-full p-2 border rounded mt-1">
                                    <option value="Request">Request</option>
                                    <option value="Issue">Issue</option>
                                    <option value="Bug">Bug</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Department</label>
                                <select id="ticketDepartment" class="w-full p-2 border rounded mt-1">
                                    <option value="Branch">Branch</option>
                                    <option value="ICT">ICT</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">Submitting For</label>
                            <select id="ticketSubmittingFor" class="w-full p-2 border rounded mt-1">
                                <option value="">Select type</option>
                                <option value="Customer">Customer</option>
                                <option value="User">User</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium">Description</label>
                            <textarea id="ticketDescription" placeholder="What happened? Provide steps or context." required class="w-full p-2 border rounded mt-1" rows="4"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
                            <div>
                                <label class="text-sm font-medium">Priority</label>
                                <select id="ticketPriority" class="w-full input mt-1">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Due Date (optional)</label>
                                <input id="ticketDueDate" type="date" class="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Attachment (optional)</label>
                                <input id="ticketAttachment" type="file" class="w-full mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Created Date</label>
                                <input id="ticketCreatedDate" type="date" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button class="btn btn-primary" type="submit">Submit Ticket</button>
                            <button type="button" class="btn btn-secondary" onclick="hideNewTicketForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded shadow">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-purple-600 to-purple-800 text-white"><tr><th class="p-3 text-left font-bold">üé´ ID</th><th class="p-3 text-left font-bold">üìã Subject</th><th class="p-3 text-left font-bold">üè∑Ô∏è Type</th><th class="p-3 text-left font-bold">‚ö° Priority</th><th class="p-3 text-left font-bold">üìÖ Created</th><th class="p-3 text-left font-bold">üë§ Creator</th><th class="p-3 text-left font-bold">üë®‚Äçüíº Assigned</th><th class="p-3 text-left font-bold">‚úì Status</th><th class="p-3 text-left font-bold">‚öôÔ∏è Actions</th></tr></thead>
                        <tbody id="ticketsList"><tr><td class="p-4 text-center" colspan="7">No tickets</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="leave" class="content-section p-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Leave Management</h2>
                    <button onclick="showNewLeaveForm()" class="btn btn-primary">+ Request Leave</button>
                </div>
                <div id="newLeaveForm" class="hidden card mb-4">
                    <form id="leaveFormEl" class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Name</label>
                                <input id="leaveName" type="text" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Email</label>
                                <input id="leaveEmail" type="email" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Leave Type</label>
                                <select id="leaveType" required class="p-2 border rounded w-full mt-1"><option value="Annual">Annual</option><option value="Sick">Sick</option><option value="Personal">Personal</option></select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Start Date</label>
                                <input id="leaveStartDate" type="date" required class="w-full p-2 border rounded mt-1" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">End Date</label>
                                <input id="leaveEndDate" type="date" required class="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Days</label>
                                <input id="leaveDays" type="number" min="0" required class="w-full input mt-1" placeholder="Calculated automatically" readonly />
                                <p class="text-xs text-gray-500 mt-1">Excludes weekends and public holidays.</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Resume Work On</label>
                                <input id="leaveResumeDate" type="date" required class="w-full p-2 border rounded mt-1" />
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">Reason (optional)</label>
                            <textarea id="leaveReason" rows="3" class="w-full p-2 border rounded mt-1" placeholder="Reason for leave"></textarea>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button class="btn btn-primary" type="submit">Submit Request</button>
                            <button type="button" class="btn btn-secondary" onclick="hideNewLeaveForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded shadow p-4">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-orange-600 to-orange-800 text-white"><tr><th class="p-3 text-left font-bold">üìã ID</th><th class="p-3 text-left font-bold">üë§ Name</th><th class="p-3 text-left font-bold">üìß Email</th><th class="p-3 text-left font-bold">üèñÔ∏è Type</th><th class="p-3 text-left font-bold">üìÖ Start Date</th><th class="p-3 text-left font-bold">üìÖ End Date</th><th class="p-3 text-left font-bold">üìÖ Resume Date</th><th class="p-3 text-left font-bold">‚è±Ô∏è Days</th><th class="p-3 text-left font-bold">‚úì Status</th></tr></thead>
                        <tbody id="leaveList"><tr><td class="p-4 text-center" colspan="9">No leave requests</td></tr></tbody>
                    </table>
                </div>
            </div>
            
            <div id="finance" class="content-section p-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Finance - Expense Claims</h2>
                    <button onclick="showNewClaimForm()" class="btn btn-primary">+ New Claim</button>
                </div>

                <div id="newClaimForm" class="hidden card mb-4">
                    <h3 class="font-semibold mb-4">Submit Expense Claim</h3>
                    <form id="claimFormEl" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Name</label>
                                <input id="claimName" type="text" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Email</label>
                                <input id="claimEmail" type="email" readonly class="w-full p-2 border rounded mt-1 bg-gray-100" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Expense Type</label>
                                <select id="claimType" required class="p-2 border rounded w-full mt-1"><option value="Travel">Travel</option><option value="Meals">Meals</option><option value="Supplies">Supplies</option><option value="Other">Other</option></select>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Amount</label>
                                <input id="claimAmount" type="number" min="0" step="0.01" required class="w-full p-2 border rounded mt-1" />
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-sm font-medium">Date</label>
                                <input id="claimDate" type="date" required class="w-full p-2 border rounded mt-1" />
                            </div>
                            <div>
                                <label class="text-sm font-medium">Receipt (optional)</label>
                                <input id="claimReceipt" type="file" class="w-full mt-1" />
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium">Description (optional)</label>
                            <textarea id="claimDescription" rows="3" class="w-full p-2 border rounded mt-1" placeholder="Details about the expense"></textarea>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button class="btn btn-primary" type="submit">Submit Claim</button>
                            <button type="button" class="btn btn-secondary" onclick="hideNewClaimForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded shadow p-4">
                    <table class="w-full">
                        <thead class="bg-gradient-to-r from-blue-600 to-blue-800 text-white"><tr><th class="p-3 text-left font-bold">üìã ID</th><th class="p-3 text-left font-bold">üë§ Name</th><th class="p-3 text-left font-bold">üìß Email</th><th class="p-3 text-left font-bold">üí∞ Type</th><th class="p-3 text-left font-bold">üíµ Amount</th><th class="p-3 text-left font-bold">üìÖ Date</th><th class="p-3 text-left font-bold">‚úì Status</th></tr></thead>
                        <tbody id="claimsList"><tr><td class="p-4 text-center" colspan="7">No claims</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="notifications" class="content-section p-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Notifications</h2>
                    <button onclick="markAllNotificationsRead()" class="btn btn-secondary text-sm">Mark All as Read</button>
                </div>

                <div id="notificationsContainer" class="space-y-3">
                    <div class="p-4 text-center text-gray-500">No notifications</div>
                </div>
            </div>
        </main>
    </div>

    <script src="approval-workflow.js"></script>
    <script>
        // Numeric auto-increment ID helper
        function getNextId(key){
            const next = JSON.parse(localStorage.getItem('nextIds') || '{}');
            if (!next[key]) next[key] = 1;
            const id = next[key]++;
            localStorage.setItem('nextIds', JSON.stringify(next));
            return String(id);
        }
        function switchSection(id){ 
            document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active')); 
            document.getElementById(id).classList.add('active');
            if (id === 'notifications') {
                loadNotifications();
            }
        }
        function showNewTicketForm(){ 
            document.getElementById('newTicketForm').classList.remove('hidden');
            const today = formatDateISO(new Date());
            const cd = document.getElementById('ticketCreatedDate');
            if(cd) cd.value = today;
        }
        function hideNewTicketForm(){ document.getElementById('newTicketForm').classList.add('hidden'); }
        function hideNewTicketForm(){ document.getElementById('newTicketForm').classList.add('hidden'); }
        function showNewLeaveForm(){
            document.getElementById('leaveName').value = localStorage.getItem('userName')||'';
            document.getElementById('leaveEmail').value = localStorage.getItem('userEmail')||'';
            document.getElementById('newLeaveForm').classList.remove('hidden');
            // show current balance for selected type
            updateLeaveTypeBalanceDisplay();
        }
        function hideNewLeaveForm(){ document.getElementById('newLeaveForm').classList.add('hidden'); }
        function logout(){
            // Clear only session-related keys to keep persistent records (tickets, employees, claims, leaveRequests)
            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userType');
            localStorage.removeItem('isAdmin');
            localStorage.removeItem('pendingUserEmail');
            window.location.href='index.html';
        }

        // init
        window.addEventListener('load', ()=>{
            if(!localStorage.getItem('userId')) { window.location.href='index.html'; return; }
            // ensure userName is present; if missing, try to derive from employees by email
            const storedName = localStorage.getItem('userName');
            const storedEmail = localStorage.getItem('userEmail');
            if ((!storedName || storedName === 'undefined') && storedEmail) {
                try {
                    const employees = JSON.parse(localStorage.getItem('employees') || '[]');
                    const match = employees.find(e => (e.email||'').toLowerCase() === (storedEmail||'').toLowerCase());
                    if (match && match.name) {
                        localStorage.setItem('userName', match.name);
                    }
                } catch (err) {
                    // ignore
                }
            }

            // Load and display user info from localStorage
            const userName = localStorage.getItem('userName') || '-';
            const userEmail = localStorage.getItem('userEmail') || '-';
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const userType = isAdmin ? 'Admin' : 'User';
            
            document.getElementById('userNameDisplay').textContent = userName;
            document.getElementById('userTypeDisplay').textContent = userType;
            document.getElementById('infoName').textContent = userName;
            document.getElementById('infoEmail').textContent = userEmail;
            document.getElementById('infoType').textContent = userType;
            
            console.log('[SYSTEM-CLEAN] User loaded:', { userName, userEmail, userType });
            
            // Initialize workflow for expense claims
            const claimWorkflowConfig = {
                moduleName: 'expense',
                steps: [
                    { stepId: 'finance-officer-review', role: 'Finance Officer', department: 'Finance', approver: 'Finance Officer' },
                    { stepId: 'head-of-finance-review', role: 'Head of Finance', department: 'Finance', approver: 'Head of Finance' }
                ]
            };
            workflow = new ApprovalWorkflow(claimWorkflowConfig);
            
            loadTickets(); loadLeaveRequests(); loadClaims(); updateStats(); loadUserBalances(); updateNotificationBadge();
            // Prefill department select with user's department if available
            try {
                const employees = JSON.parse(localStorage.getItem('employees')||'[]');
                const meEmail = (localStorage.getItem('userEmail')||'').toLowerCase();
                const me = employees.find(e => (e.email||'').toLowerCase() === meEmail);
                if (me && me.department) {
                    const deptEl = document.getElementById('ticketDepartment');
                    if (deptEl) deptEl.value = me.department;
                }
            } catch(e){}
        });

        // Department-based assignment helper
        function getAssigneeByDepartment(dept, excludeId) {
            const employees = JSON.parse(localStorage.getItem('employees')||'[]');
            let candidates = [];
            
            // Handle special portal departments
            if ((dept||'').toLowerCase() === 'finance') {
                const financeUsers = JSON.parse(localStorage.getItem('financeUsers')||'[]');
                candidates = financeUsers.filter(u => u.id !== excludeId);
            } else if ((dept||'').toLowerCase() === 'admin') {
                candidates = employees.filter(e => (e.type||'').toLowerCase() === 'admin' && e.id !== excludeId);
            } else if ((dept||'').toLowerCase() === 'branch') {
                const branchUsers = JSON.parse(localStorage.getItem('branchUsers')||'[]');
                candidates = branchUsers.filter(u => u.id !== excludeId);
            } else {
                candidates = employees.filter(e => (e.department||'').toLowerCase() === (dept||'').toLowerCase() && (e.type||'user').toLowerCase() !== 'admin' && e.id !== excludeId);
            }
            
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            if (!candidates || candidates.length === 0) return null;
            function openCount(id){ return tickets.filter(t => t.assignedTo === id && t.status !== 'Closed').length; }
            candidates.sort((a,b)=> openCount(a.id) - openCount(b.id));
            return candidates[0] || null;
        }

        function pushSentEmail(to, subject, body){ const sent = JSON.parse(localStorage.getItem('sentEmails')||'[]'); sent.push({to,subject,body,sentAt:new Date().toISOString()}); localStorage.setItem('sentEmails', JSON.stringify(sent)); }

            function loadUserBalances(){
                const email = (localStorage.getItem('userEmail')||'').toLowerCase();
                const employees = JSON.parse(localStorage.getItem('employees')||'[]');
                const u = employees.find(e => (e.email||'').toLowerCase() === email);
                const balAnnual = document.getElementById('balAnnual');
                const balSick = document.getElementById('balSick');
                const balPersonal = document.getElementById('balPersonal');
                if (!u || !u.leaveBalances) {
                    balAnnual.textContent = '0'; balSick.textContent = '0'; balPersonal.textContent = '0';
                } else {
                    balAnnual.textContent = u.leaveBalances.annual || 0;
                    balSick.textContent = u.leaveBalances.sick || 0;
                    balPersonal.textContent = u.leaveBalances.personal || 0;
                }
            }

        function updateStats(){ 
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]'); 
            const userEmail = localStorage.getItem('userEmail');
            const userId = localStorage.getItem('userId');
            const employees = JSON.parse(localStorage.getItem('employees')||'[]');
            const userDept = (employees.find(e=>e.id===userId) || {}).department || '';
            const isAdmin = localStorage.getItem('isAdmin')==='true';
            
            // User tickets
            const userTickets = isAdmin ? tickets : tickets.filter(t=> t.email === userEmail || t.assignedTo === userId || (t.department && t.department.toLowerCase() === (userDept||'').toLowerCase()));
            const totalTicketsEl = document.getElementById('totalTickets');
            const openTicketsEl = document.getElementById('openTickets');
            if (totalTicketsEl) totalTicketsEl.textContent = userTickets.length;
            if (openTicketsEl) openTicketsEl.textContent = userTickets.filter(t=>t.status==='Open').length;
            
            // User claims
            const claims = JSON.parse(localStorage.getItem('claims')||'[]');
            const userClaims = isAdmin ? claims : claims.filter(c => c.email === userEmail);
            const totalClaimsEl = document.getElementById('totalClaims');
            const pendingClaimsEl = document.getElementById('pendingClaims');
            if (totalClaimsEl) totalClaimsEl.textContent = userClaims.length;
            if (pendingClaimsEl) pendingClaimsEl.textContent = userClaims.filter(c => c.status === 'Pending').length;
            
            // User leave
            const leaveRequests = JSON.parse(localStorage.getItem('leaveRequests')||'[]');
            const userLeave = isAdmin ? leaveRequests : leaveRequests.filter(r => r.email === userEmail);
            const totalLeaveEl = document.getElementById('totalLeave');
            const pendingLeaveEl = document.getElementById('pendingLeave');
            if (totalLeaveEl) totalLeaveEl.textContent = userLeave.length;
            if (pendingLeaveEl) pendingLeaveEl.textContent = userLeave.filter(r => r.status === 'Pending').length;
            
            // User notifications
            const notifications = JSON.parse(localStorage.getItem('userNotifications')||'[]');
            const userNotifications = notifications.filter(n => n.userEmail === userEmail);
            const totalNotificationsEl = document.getElementById('totalNotifications');
            const unreadNotificationsEl = document.getElementById('unreadNotifications');
            if (totalNotificationsEl) totalNotificationsEl.textContent = userNotifications.length;
            if (unreadNotificationsEl) unreadNotificationsEl.textContent = userNotifications.filter(n => !n.read).length;
            
            loadDashboardActivity();
        }

        function loadDashboardActivity() {
            const userEmail = localStorage.getItem('userEmail');
            const userId = localStorage.getItem('userId');
            const employees = JSON.parse(localStorage.getItem('employees')||'[]');
            const userDept = (employees.find(e=>e.id===userId) || {}).department || '';
            const isAdmin = localStorage.getItem('isAdmin')==='true';
            
            let activities = [];
            
            // Get recent tickets
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            const userTickets = isAdmin ? tickets : tickets.filter(t=> t.email === userEmail || t.assignedTo === userId || (t.department && t.department.toLowerCase() === (userDept||'').toLowerCase()));
            userTickets.slice(-5).reverse().forEach(t => {
                activities.push({
                    type: 'ticket',
                    icon: 'üé´',
                    title: `Ticket #${t.id}: ${t.subject}`,
                    status: t.status,
                    color: t.status === 'Open' ? 'yellow' : t.status === 'Closed' ? 'green' : 'blue',
                    date: t.createdDate || t.timestamp
                });
            });
            
            // Get recent claims
            const claims = JSON.parse(localStorage.getItem('claims')||'[]');
            const userClaims = isAdmin ? claims : claims.filter(c => c.email === userEmail);
            userClaims.slice(-5).reverse().forEach(c => {
                activities.push({
                    type: 'claim',
                    icon: 'üíº',
                    title: `Claim #${c.id}: ${c.type} - ‚Ç¶${parseFloat(c.amount).toFixed(2)}`,
                    status: c.status,
                    color: c.status === 'Pending' ? 'yellow' : c.status === 'Approved' ? 'green' : 'red',
                    date: c.timestamp
                });
            });
            
            // Get recent leave
            const leaveRequests = JSON.parse(localStorage.getItem('leaveRequests')||'[]');
            const userLeave = isAdmin ? leaveRequests : leaveRequests.filter(r => r.email === userEmail);
            userLeave.slice(-5).reverse().forEach(r => {
                activities.push({
                    type: 'leave',
                    icon: 'üèñÔ∏è',
                    title: `${r.type} Leave: ${r.startDate} to ${r.endDate} (${r.days} days)`,
                    status: r.status,
                    color: r.status === 'Pending' ? 'yellow' : r.status === 'Approved' ? 'green' : 'red',
                    date: r.timestamp
                });
            });
            
            // Get recent notifications
            const notifications = JSON.parse(localStorage.getItem('userNotifications')||'[]');
            const userNotifications = notifications.filter(n => n.userEmail === userEmail);
            userNotifications.slice(-5).reverse().forEach(n => {
                activities.push({
                    type: 'notification',
                    icon: '‚úÖ',
                    title: `Claim #${n.claimId} disbursed: ‚Ç¶${parseFloat(n.amount).toFixed(2)}`,
                    status: n.read ? 'Read' : 'New',
                    color: n.read ? 'gray' : 'orange',
                    date: n.createdAt
                });
            });
            
            // Sort by date and take last 10
            activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            activities = activities.slice(0, 10);
            
            const container = document.getElementById('recentActivityContainer');
            if (!container) {
                console.warn('[DASHBOARD] recentActivityContainer not found in DOM');
                return;
            }
            
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No recent activity</p>';
                return;
            }
            
            const colorMap = { yellow: 'border-yellow-300 bg-yellow-50', green: 'border-green-300 bg-green-50', blue: 'border-blue-300 bg-blue-50', red: 'border-red-300 bg-red-50', orange: 'border-orange-300 bg-orange-50', gray: 'border-gray-300 bg-gray-50' };
            const statusColorMap = { 'Open': 'text-yellow-700', 'Closed': 'text-green-700', 'Blue': 'text-blue-700', 'Pending': 'text-yellow-700', 'Approved': 'text-green-700', 'Rejected': 'text-red-700', 'New': 'text-orange-700', 'Read': 'text-gray-700' };
            
            container.innerHTML = activities.map(a => `
                <div class="border-l-4 ${colorMap[a.color]} p-4 rounded flex items-start justify-between hover:shadow-sm transition">
                    <div class="flex items-start gap-3 flex-1">
                        <span class="text-2xl">${a.icon}</span>
                        <div>
                            <p class="font-semibold text-gray-800">${a.title}</p>
                            <p class="text-xs text-gray-500 mt-1">${new Date(a.date).toLocaleString()}</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColorMap[a.status]} ${a.color === 'yellow' ? 'bg-yellow-100' : a.color === 'green' ? 'bg-green-100' : a.color === 'blue' ? 'bg-blue-100' : a.color === 'red' ? 'bg-red-100' : a.color === 'orange' ? 'bg-orange-100' : 'bg-gray-100'}">${a.status}</span>
                </div>
            `).join('');
        }

        function loadTickets(){
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            const employees = JSON.parse(localStorage.getItem('employees')||'[]');
            const isAdmin = localStorage.getItem('isAdmin')==='true';
            const userEmail = localStorage.getItem('userEmail');
            const userId = localStorage.getItem('userId');
            const userDept = (employees.find(e=>e.id===userId) || {}).department || '';
            const filtered = isAdmin ? tickets : tickets.filter(t=> t.email === userEmail || t.assignedTo === userId || (t.department && t.department.toLowerCase() === (userDept||'').toLowerCase()));
            const tbody = document.getElementById('ticketsList');
            if (!filtered || filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center">No tickets</td></tr>'; return; }
            tbody.innerHTML = filtered.map(t => {
                const assignee = employees.find(e => e.id === t.assignedTo);
                const assigneeName = assignee ? assignee.name : (t.assignedToName || 'Unassigned');
                const currentUserId = localStorage.getItem('userId');
                const currentEmail = localStorage.getItem('userEmail');
                const isAdmin = localStorage.getItem('isAdmin')==='true';
                const isCreator = t.email === currentEmail;
                const isAssigned = currentUserId === t.assignedTo;
                const isInDept = (employees.find(e=>e.id===currentUserId)||{}).department && ((employees.find(e=>e.id===currentUserId)||{}).department||'').toLowerCase() === (t.department||'').toLowerCase();
                const canAct = isAdmin || isAssigned || isInDept || isCreator;
                
                const actions = [];
                if (t.status !== 'Closed') {
                    actions.push(`<button onclick="resolveTicket('${t.id}')" class="text-sm text-yellow-600 hover:underline mr-2">Resolve</button>`);
                    actions.push(`<button onclick="closeTicket('${t.id}')" class="text-sm text-green-600 hover:underline mr-2">Close</button>`);
                    actions.push(`<button onclick="commentTicket('${t.id}')" class="text-sm text-gray-600 hover:underline">Comment</button>`);
                }
                if (isAdmin) actions.push(`<button onclick="reassignTicket && reassignTicket('${t.id}')" class="text-sm text-indigo-600 hover:underline ml-2">Reassign</button>`);
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-2">${t.id}</td>
                        <td class="p-2">${t.subject || ''}</td>
                        <td class="p-2">${t.type || ''}</td>
                        <td class="p-2">${t.priority || ''}</td>
                        <td class="p-2">${t.createdDate || (t.timestamp ? t.timestamp.split('T')[0] : '')}</td>
                        <td class="p-2">${t.name || ''}</td>
                        <td class="p-2">${assigneeName}</td>
                        <td class="p-2">${t.status || ''}</td>
                        <td class="p-2">${actions.join(' ')} <button onclick="openTicketModal('view','${t.id}')" class="text-sm text-blue-600 hover:underline ml-2">View</button></td>
                    </tr>
                `;
            }).join('');
        }

        function resolveTicket(ticketId){
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            const employees = JSON.parse(localStorage.getItem('employees')||'[]');
            const t = tickets.find(x=>x.id===ticketId);
            if(!t){ alert('Ticket not found'); return; }
            const actorId = localStorage.getItem('userId');
            const actor = employees.find(e=>e.id===actorId);
            const isAdmin = localStorage.getItem('isAdmin')==='true';
            const isAssignee = actorId === t.assignedTo;
            const isDeptMember = actor && actor.department && (actor.department||'').toLowerCase() === (t.department||'').toLowerCase();
            if(!(isAdmin || isAssignee || isDeptMember)) { alert('You are not authorized to resolve this ticket.'); return; }
            const notes = prompt('Resolution notes (optional):');
            t.status = 'Resolved';
            t.resolvedAt = new Date().toISOString();
            t.resolvedBy = actorId;
            t.resolvedByName = actor ? actor.name : '';
            t.resolutionNotes = (t.resolutionNotes||'') + (notes ? '\n' + notes : '');
            t.history = t.history || [];
            t.history.push({ action: 'resolved', by: actorId, byName: t.resolvedByName, at: t.resolvedAt, notes: notes || '' });
            localStorage.setItem('tickets', JSON.stringify(tickets));
            pushSentEmail(t.email, 'Your ticket '+t.id+' was resolved', 'Resolution: ' + (notes||''));
            if(t.assignedTo) pushSentEmail((employees.find(e=>e.id===t.assignedTo)||{}).email || '', 'Ticket '+t.id+' resolved', 'Ticket resolved by '+(actor?actor.name:''));
            loadTickets(); updateStats(); alert('Ticket resolved.');
        }

        function commentTicket(ticketId){
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            const employees = JSON.parse(localStorage.getItem('employees')||'[]');
            const t = tickets.find(x=>x.id===ticketId);
            if(!t){ alert('Ticket not found'); return; }
            const actorId = localStorage.getItem('userId');
            const actor = employees.find(e=>e.id===actorId);
            const note = prompt('Add comment:');
            if(!note) return;
            t.history = t.history || [];
            t.history.push({ action: 'comment', by: actorId, byName: actor ? actor.name : '', at: new Date().toISOString(), notes: note });
            localStorage.setItem('tickets', JSON.stringify(tickets));
            // notify ticket participants
            pushSentEmail(t.email, 'New comment on ticket '+t.id, note);
            if(t.assignedTo) pushSentEmail((employees.find(e=>e.id===t.assignedTo)||{}).email || '', 'New comment on ticket '+t.id, note);
            alert('Comment saved.');
            loadTickets();
        }

        // Modal UI for ticket actions (notes / comments)
        let ticketModalState = { action: null, ticketId: null };
        function openTicketModal(action, ticketId){
            ticketModalState.action = action; ticketModalState.ticketId = ticketId;
            const title = document.getElementById('ticketModalTitle');
            const notes = document.getElementById('ticketModalNotes');
            const select = document.getElementById('ticketModalSelect');
            // reset
            notes.value = '';
            select.innerHTML = '';
            notes.classList.remove('hidden'); select.classList.add('hidden');
            if (action === 'reassign') {
                title.textContent = 'Reassign Ticket';
                // populate select with employees, but exclude the ticket creator
                const employees = JSON.parse(localStorage.getItem('employees')||'[]');
                const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
                const t = tickets.find(x=>x.id===ticketId) || {};
                const creatorEmail = (t.email || t.createdByEmail || '').toLowerCase();
                employees.forEach(e=>{
                    if ((e.email||'').toLowerCase() === creatorEmail) return; // skip creator
                    const opt = document.createElement('option'); opt.value = e.id; opt.text = `${e.name} (${e.email}) [${e.department||''}]`; select.appendChild(opt);
                });
                notes.classList.add('hidden'); select.classList.remove('hidden');
            } else if (action === 'comment') {
                title.textContent = 'Add Comment'; notes.placeholder = 'Write a comment...';
            } else if (action === 'resolve') {
                title.textContent = 'Resolve Ticket'; notes.placeholder = 'Resolution notes (optional)';
            } else if (action === 'close') {
                title.textContent = 'Close Ticket'; notes.placeholder = 'Closure notes (optional)';
            }
            document.getElementById('ticketModal').classList.remove('hidden');
        }

        function closeTicket(ticketId){ openTicketModal('close', ticketId); }
        function resolveTicket(ticketId){ openTicketModal('resolve', ticketId); }
        function commentTicket(ticketId){ openTicketModal('comment', ticketId); }

        document.getElementById('ticketModalCancel') && document.getElementById('ticketModalCancel').addEventListener('click', ()=>{ document.getElementById('ticketModal').classList.add('hidden'); });
        document.getElementById('ticketModalSave') && document.getElementById('ticketModalSave').addEventListener('click', ()=>{
            const action = ticketModalState.action; const ticketId = ticketModalState.ticketId;
            const notes = document.getElementById('ticketModalNotes').value;
            const select = document.getElementById('ticketModalSelect');
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            const employees = JSON.parse(localStorage.getItem('employees')||'[]');
            const t = tickets.find(x=>x.id===ticketId);
            if(!t){ alert('Ticket not found'); document.getElementById('ticketModal').classList.add('hidden'); return; }
            const actorId = localStorage.getItem('userId');
            const actor = employees.find(e=>e.id===actorId) || { name: localStorage.getItem('userName') };
            if(action === 'comment'){
                t.history = t.history || [];
                t.history.push({ action: 'comment', by: actorId, byName: actor.name, at: new Date().toISOString(), notes: notes });
                pushSentEmail(t.email, 'New comment on ticket '+t.id, notes);
                if(t.assignedTo) pushSentEmail((employees.find(e=>e.id===t.assignedTo)||{}).email||'', 'New comment on ticket '+t.id, notes);
            } else if(action === 'resolve'){
                t.status = 'Resolved'; t.resolvedAt = new Date().toISOString(); t.resolvedBy = actorId; t.resolvedByName = actor.name; t.resolutionNotes = (t.resolutionNotes||'') + (notes ? '\n'+notes : '');
                t.history = t.history || [];
                t.history.push({ action: 'resolved', by: actorId, byName: actor.name, at: t.resolvedAt, notes: notes||'' });
                pushSentEmail(t.email, 'Your ticket '+t.id+' was resolved', notes||'');
                if(t.assignedTo) pushSentEmail((employees.find(e=>e.id===t.assignedTo)||{}).email||'', 'Ticket '+t.id+' resolved', notes||'');
            } else if(action === 'close'){
                t.status = 'Closed'; t.closedAt = new Date().toISOString(); t.closedBy = actorId; t.closedByName = actor.name; t.resolutionNotes = (t.resolutionNotes||'') + (notes ? '\n'+notes : '');
                t.history = t.history || [];
                t.history.push({ action: 'closed', by: actorId, byName: actor.name, at: t.closedAt, notes: notes||'' });
                pushSentEmail(t.email, 'Your ticket '+t.id+' was closed', notes||'');
                if(t.assignedTo) pushSentEmail((employees.find(e=>e.id===t.assignedTo)||{}).email||'', 'Ticket '+t.id+' closed', notes||'');
            } else if(action === 'reassign'){
                const assigneeId = select.value; const assignee = employees.find(e=>e.id===assigneeId);
                if(!assignee){ alert('Assignee not selected'); return; }
                t.assignedTo = assignee.id; t.assignedToName = assignee.name; t.assignedDept = assignee.department || t.department; t.assignedAt = new Date().toISOString();
                t.history = t.history || []; t.history.push({ action: 'reassigned', by: actorId, byName: actor.name, at: new Date().toISOString(), notes: 'Reassigned to '+assignee.name });
                pushSentEmail(assignee.email, 'Ticket assigned: '+t.id, 'You were assigned ticket '+t.id);
            }
            localStorage.setItem('tickets', JSON.stringify(tickets));
            document.getElementById('ticketModal').classList.add('hidden');
            loadTickets(); updateStats();
            alert((action.charAt(0).toUpperCase()+action.slice(1)) + ' action completed.');
        });

        document.getElementById('ticketFormEl').addEventListener('submit', function(e){
            e.preventDefault();
            const id = getNextId('tickets');
            const attachmentInput = document.getElementById('ticketAttachment');
            const attachmentName = attachmentInput && attachmentInput.files && attachmentInput.files[0] ? attachmentInput.files[0].name : null;
            const existingTickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            const employees = JSON.parse(localStorage.getItem('employees')||'[]');
            const dept = document.getElementById('ticketDepartment') ? document.getElementById('ticketDepartment').value : '';
            const currentUserId = localStorage.getItem('userId');
            let assignee = getAssigneeByDepartment(dept, currentUserId);
            if (!assignee) {
                const admins = employees.filter(e => (e.type||'').toLowerCase() === 'admin');
                if (admins.length > 0) {
                    let minCount = Infinity;
                    admins.forEach(a => {
                        if (a.id === currentUserId) return; // do not assign back to creator
                        const c = existingTickets.filter(t => t.assignedTo === a.id && t.status === 'Open').length;
                        if (c < minCount) { minCount = c; assignee = a; }
                    });
                }
            }
            const ticket = {
                id,
                name: localStorage.getItem('userName') || '',
                type: document.getElementById('ticketType').value || 'Request',
                subject: document.getElementById('ticketSubject').value,
                description: document.getElementById('ticketDescription').value,
                priority: document.getElementById('ticketPriority').value || 'Low',
                dueDate: document.getElementById('ticketDueDate').value || null,
                attachment: attachmentName,
                status: 'Open',
                email: localStorage.getItem('userEmail'),
                timestamp: new Date().toISOString(),
                createdAt: new Date().toISOString(),
                createdDate: (document.getElementById('ticketCreatedDate') && document.getElementById('ticketCreatedDate').value) ? document.getElementById('ticketCreatedDate').value : formatDateISO(new Date()),
                createdByName: localStorage.getItem('userName') || '',
                createdByEmail: localStorage.getItem('userEmail') || '',
                department: dept || '',
                assignedTo: assignee ? assignee.id : null,
                assignedToName: assignee ? assignee.name : null,
                assignedDept: assignee ? (assignee.department||dept) : null,
                assignedAt: assignee ? new Date().toISOString() : null,
                history: []
            };
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            tickets.push(ticket);
            localStorage.setItem('tickets', JSON.stringify(tickets));
            hideNewTicketForm();
            this.reset();
            loadTickets();
            updateStats();
            if (ticket.assignedToName) {
                pushSentEmail(ticket.assignedToName + ' <' + (assignee.email||'') + '>', 'New ticket assigned: ' + ticket.id, 'Ticket '+ticket.id+' has been assigned to you.');
            }
            alert('Ticket submitted: ' + id + (ticket.assignedToName ? (' (assigned to ' + ticket.assignedToName + ')') : ''));
        });

        function closeTicket(ticketId){
            const tickets = JSON.parse(localStorage.getItem('tickets')||'[]');
            const employees = JSON.parse(localStorage.getItem('employees')||'[]');
            const t = tickets.find(x=>x.id===ticketId);
            if(!t) { alert('Ticket not found'); return; }
            const actorId = localStorage.getItem('userId');
            const actor = employees.find(e=>e.id===actorId);
            const isAdmin = localStorage.getItem('isAdmin')==='true';
            const isAssignee = actorId === t.assignedTo;
            const isDeptMember = actor && actor.department && (actor.department||'').toLowerCase() === (t.department||'').toLowerCase();
            if(!(isAdmin || isAssignee || isDeptMember)) { alert('You are not authorized to close this ticket.'); return; }
            const notes = prompt('Resolution notes (optional):');
            t.status = 'Closed';
            t.closedAt = new Date().toISOString();
            t.closedBy = actorId;
            t.closedByName = actor ? actor.name : '';
            t.resolutionNotes = notes || '';
            t.history = t.history || [];
            t.history.push({ action: 'closed', by: actorId, byName: t.closedByName, at: t.closedAt, notes: t.resolutionNotes });
            localStorage.setItem('tickets', JSON.stringify(tickets));
            // notify creator and assignee
            pushSentEmail(t.email, 'Your ticket '+t.id+' was closed', 'Resolution: ' + (t.resolutionNotes||''));
            if(t.assignedTo) pushSentEmail(t.assignedToName + ' <'+( (employees.find(e=>e.id===t.assignedTo)||{}).email || '' )+'>', 'Ticket '+t.id+' closed', 'Ticket closed by '+(actor?actor.name:'') );
            loadTickets(); updateStats();
            alert('Ticket closed.');
        }

        // Public holidays (YYYY-MM-DD) - edit as needed
        const PUBLIC_HOLIDAYS = [
            // example: New Year's Day 2026
            '2026-01-01'
            // add more dates here
        ];

        function isPublicHoliday(dateStr) {
            return PUBLIC_HOLIDAYS.includes(dateStr);
        }

        function formatDateISO(d) {
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const dd = String(d.getDate()).padStart(2,'0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function calculateLeaveDays() {
            const startVal = document.getElementById('leaveStartDate').value;
            const endVal = document.getElementById('leaveEndDate').value;
            const daysEl = document.getElementById('leaveDays');
            if (!startVal || !endVal) { daysEl.value = 0; return 0; }
            const start = new Date(startVal + 'T00:00:00');
            const end = new Date(endVal + 'T00:00:00');
            if (end < start) { daysEl.value = 0; return 0; }
            let count = 0;
            for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
                const day = d.getDay(); // 0=Sun,6=Sat
                if (day === 0 || day === 6) continue; // skip weekends
                const iso = formatDateISO(d);
                if (isPublicHoliday(iso)) continue; // skip public holidays
                count++;
            }
            daysEl.value = count;
            return count;
        }

        document.getElementById('leaveStartDate').addEventListener('change', calculateLeaveDays);
        document.getElementById('leaveEndDate').addEventListener('change', calculateLeaveDays);

        // Claims (Finance)
        function showNewClaimForm(){
            document.getElementById('claimName').value = localStorage.getItem('userName')||'';
            document.getElementById('claimEmail').value = localStorage.getItem('userEmail')||'';
            document.getElementById('newClaimForm').classList.remove('hidden');
        }
        function hideNewClaimForm(){ document.getElementById('newClaimForm').classList.add('hidden'); }

        function loadClaims(){ const claims = JSON.parse(localStorage.getItem('claims')||'[]'); const isAdmin = localStorage.getItem('isAdmin')==='true'; const userEmail = localStorage.getItem('userEmail'); const filtered = isAdmin?claims:claims.filter(c=>c.email===userEmail); const tbody = document.getElementById('claimsList'); if(filtered.length===0){ tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center">No claims</td></tr>'; return; } tbody.innerHTML = filtered.map(c=>`<tr><td class="p-2">${c.id}</td><td class="p-2">${c.name||''}</td><td class="p-2">${c.email||''}</td><td class="p-2">${c.type}</td><td class="p-2">${c.amount}</td><td class="p-2">${c.date||''}</td><td class="p-2">${c.status}</td></tr>`).join(''); }

        function loadNotifications(){
            const userEmail = localStorage.getItem('userEmail');
            const allNotifications = JSON.parse(localStorage.getItem('userNotifications') || '[]');
            const userNotifications = allNotifications.filter(n => n.userEmail === userEmail);
            const container = document.getElementById('notificationsContainer');
            const badge = document.getElementById('notificationBadge');
            
            // Count unread notifications
            const unreadCount = userNotifications.filter(n => !n.read).length;
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
            
            if (userNotifications.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No notifications</div>';
                return;
            }
            
            container.innerHTML = userNotifications.map(n => `
                <div class="card ${!n.read ? 'border-l-4 border-l-yellow-400 bg-yellow-50' : 'bg-gray-50'} p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="font-semibold text-lg">
                                ${n.type === 'disbursement_complete' ? '‚úÖ Disbursement Complete' : 'Notification'}
                            </p>
                            <p class="text-gray-700 mt-1">${n.message || ''}</p>
                            <div class="grid grid-cols-2 gap-4 mt-2 text-sm">
                                <div>
                                    <span class="text-gray-500">Claim #:</span>
                                    <span class="font-semibold">${n.claimId || 'N/A'}</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Amount:</span>
                                    <span class="font-semibold">‚Ç¶${parseFloat(n.amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">
                                ${new Date(n.createdAt).toLocaleString()}
                            </p>
                        </div>
                        <div class="flex gap-2 ml-4">
                            ${!n.read ? `<button onclick="markNotificationRead('${n.id}')" class="btn btn-sm btn-primary">Mark Read</button>` : ''}
                            <button onclick="deleteNotification('${n.id}')" class="btn btn-sm btn-secondary">Dismiss</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function markNotificationRead(notificationId){
            const allNotifications = JSON.parse(localStorage.getItem('userNotifications') || '[]');
            const notification = allNotifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                localStorage.setItem('userNotifications', JSON.stringify(allNotifications));
                loadNotifications();
                updateNotificationBadge();
            }
        }

        function deleteNotification(notificationId){
            if (!confirm('Delete this notification?')) return;
            const allNotifications = JSON.parse(localStorage.getItem('userNotifications') || '[]');
            const filtered = allNotifications.filter(n => n.id !== notificationId);
            localStorage.setItem('userNotifications', JSON.stringify(filtered));
            loadNotifications();
            updateNotificationBadge();
        }

        function markAllNotificationsRead(){
            const userEmail = localStorage.getItem('userEmail');
            const allNotifications = JSON.parse(localStorage.getItem('userNotifications') || '[]');
            allNotifications.forEach(n => {
                if (n.userEmail === userEmail) n.read = true;
            });
            localStorage.setItem('userNotifications', JSON.stringify(allNotifications));
            loadNotifications();
            updateNotificationBadge();
        }

        function updateNotificationBadge(){
            const userEmail = localStorage.getItem('userEmail');
            const allNotifications = JSON.parse(localStorage.getItem('userNotifications') || '[]');
            const unreadCount = allNotifications.filter(n => n.userEmail === userEmail && !n.read).length;
            const badge = document.getElementById('notificationBadge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        document.getElementById('claimFormEl').addEventListener('submit', function(e){
            e.preventDefault();
            const nextIds = JSON.parse(localStorage.getItem('claimNextId') || '{"id": 1}');
            const id = String(nextIds.id);
            nextIds.id++;
            localStorage.setItem('claimNextId', JSON.stringify(nextIds));
            const type = document.getElementById('claimType').value;
            const amount = parseFloat(document.getElementById('claimAmount').value)||0;
            const date = document.getElementById('claimDate').value;
            const receiptInput = document.getElementById('claimReceipt');
            const receiptName = receiptInput && receiptInput.files && receiptInput.files[0] ? receiptInput.files[0].name : null;
            const desc = document.getElementById('claimDescription').value||'';
            if(amount <= 0){ alert('Enter a valid amount'); return; }
            
            const claimName = localStorage.getItem('userName')||'';
            const claimEmail = localStorage.getItem('userEmail')||'';
            
            // Create claim object for old system.html compatibility
            const oldClaim = { id, name: claimName, email: claimEmail, type, amount, date, receipt: receiptName, description: desc, status: 'Pending', approverDept: 'Finance', timestamp: new Date().toISOString() };
            const claims = JSON.parse(localStorage.getItem('claims')||'[]'); 
            claims.push(oldClaim); 
            localStorage.setItem('claims', JSON.stringify(claims));
            
            // Create claim object for new workflow system
            const workflowClaim = {
                id,
                claimant: claimName,
                email: claimEmail,
                type,
                amount,
                description: desc,
                status: 'SUBMITTED',
                timestamp: new Date().toISOString()
            };
            const expenseClaims = JSON.parse(localStorage.getItem('expenseClaims')||'[]');
            expenseClaims.push(workflowClaim);
            localStorage.setItem('expenseClaims', JSON.stringify(expenseClaims));

            // Create notification for claimant
            const notifications = JSON.parse(localStorage.getItem('userNotifications') || '[]');
            notifications.push({
                id: 'NOTIF-' + Date.now(),
                userEmail: claimEmail,
                claimId: id,
                message: `Claim submitted: ${id}\nStatus: Awaiting Finance Officer Review`,
                type: 'claim_submitted',
                createdAt: new Date().toISOString(),
                read: false
            });

            // Notify all finance users so assigned officers get alerted
            const financeUsers = JSON.parse(localStorage.getItem('financeUsers') || '[]');
            financeUsers.forEach(fu => {
                notifications.push({
                    id: 'NOTIF-' + Date.now() + '-' + (fu.email||'').replace(/[^a-z0-9@.]/gi,''),
                    userEmail: fu.email,
                    claimId: id,
                    message: `New claim ${id} submitted by ${claimName} - awaiting your review`,
                    type: 'new_claim_assigned',
                    createdAt: new Date().toISOString(),
                    read: false
                });
            });

            localStorage.setItem('userNotifications', JSON.stringify(notifications));

            // Create approval workflow
            try {
                workflow.createWorkflow(id, 'expense', workflowClaim, claimEmail);
                alert('Claim submitted: ' + id + '\n\nStatus: Awaiting Finance Officer Review');
            } catch(e) {
                alert('Error creating workflow: ' + e.message);
            }
            
            hideNewClaimForm(); 
            this.reset(); 
            loadClaims();
        });

        function loadLeaveRequests(){
            const reqs = JSON.parse(localStorage.getItem('leaveRequests')||'[]');
            const isAdmin = localStorage.getItem('isAdmin')==='true';
            const userEmail = localStorage.getItem('userEmail');
            const filtered = isAdmin ? reqs : reqs.filter(r => r.email === userEmail);
            const tbody = document.getElementById('leaveList');
            if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="9" class="p-4 text-center">No leave requests</td></tr>'; return; }
            tbody.innerHTML = filtered.map(r => `
                <tr>
                    <td class="p-2">${r.id}</td>
                    <td class="p-2">${r.name||''}</td>
                    <td class="p-2">${r.email||''}</td>
                    <td class="p-2">${r.type}</td>
                    <td class="p-2">${r.startDate||''}</td>
                    <td class="p-2">${r.endDate||''}</td>
                    <td class="p-2">${r.resumeDate||''}</td>
                    <td class="p-2">${r.days}</td>
                    <td class="p-2">${r.status}${r.status === 'Rejected' && r.rejectReason ? (' - Reason: ' + r.rejectReason) : ''}</td>
                </tr>
            `).join('');
        }

        document.getElementById('leaveFormEl').addEventListener('submit', function(e){
            e.preventDefault();
            const id = getNextId('leaveRequests');
            const start = document.getElementById('leaveStartDate').value;
            const end = document.getElementById('leaveEndDate').value;
            const resume = document.getElementById('leaveResumeDate').value;
            // recalculate to ensure accuracy
            const daysCalculated = calculateLeaveDays();
            if (daysCalculated <= 0) { alert('Invalid leave range or zero working days selected.'); return; }
            // Check user's available balance for selected leave type
            const leaveTypeVal = (document.getElementById('leaveType').value || '').toLowerCase();
            const key = leaveTypeVal === 'annual' || leaveTypeVal === 'annual leave' ? 'annual' : (leaveTypeVal === 'sick' ? 'sick' : (leaveTypeVal === 'personal' ? 'personal' : leaveTypeVal));
            const employees = JSON.parse(localStorage.getItem('employees') || '[]');
            const userEmail = (localStorage.getItem('userEmail') || '').toLowerCase();
            const me = employees.find(e => (e.email||'').toLowerCase() === userEmail);
            const available = (me && me.leaveBalances && typeof me.leaveBalances[key] === 'number') ? me.leaveBalances[key] : 0;
            if (daysCalculated > available) {
                alert('Insufficient ' + key + ' leave balance. You have ' + available + ' days available but requested ' + daysCalculated + '.');
                return;
            }
            const req = {
                id,
                name: localStorage.getItem('userName') || '',
                email: localStorage.getItem('userEmail'),
                type: document.getElementById('leaveType').value,
                days: daysCalculated,
                startDate: start,
                endDate: end,
                resumeDate: resume,
                reason: document.getElementById('leaveReason').value || '',
                status: 'Pending',
                timestamp: new Date().toISOString()
            };
            const reqs = JSON.parse(localStorage.getItem('leaveRequests')||'[]');
            reqs.push(req);
            localStorage.setItem('leaveRequests', JSON.stringify(reqs));
            hideNewLeaveForm();
            this.reset();
            // refresh balances display (will update once admin approves)
            loadUserBalances();
            loadLeaveRequests();
            alert('Leave request submitted: '+id);
        });

        // Show user's current balance for selected leave type when request form opens
        function updateLeaveTypeBalanceDisplay(){
            const type = (document.getElementById('leaveType').value || '').toLowerCase();
            const email = (localStorage.getItem('userEmail')||'').toLowerCase();
            const employees = JSON.parse(localStorage.getItem('employees')||'[]');
            const u = employees.find(e=> (e.email||'').toLowerCase()===email);
            let val = 0;
            if (u && u.leaveBalances) {
                if (type === 'annual') val = u.leaveBalances.annual || 0;
                else if (type === 'sick') val = u.leaveBalances.sick || 0;
                else if (type === 'personal') val = u.leaveBalances.personal || 0;
            }
            // display a small helper under the select
            let helper = document.getElementById('leaveTypeHelper');
            if (!helper) {
                helper = document.createElement('p');
                helper.id = 'leaveTypeHelper';
                helper.className = 'text-xs text-gray-500 mt-1';
                document.getElementById('leaveType').parentNode.appendChild(helper);
            }
            helper.textContent = 'Available balance: ' + val + ' days';
        }
        document.getElementById('leaveType').addEventListener('change', updateLeaveTypeBalanceDisplay);
    </script>
    <!-- Ticket action modal -->
    <div id="ticketModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40">
        <div class="bg-white rounded-lg w-11/12 max-w-md p-4">
            <h3 id="ticketModalTitle" class="text-lg font-semibold">Action</h3>
            <div id="ticketModalBody" class="mt-3">
                <textarea id="ticketModalNotes" class="w-full p-2 border rounded" rows="5" placeholder="Notes..."></textarea>
                <select id="ticketModalSelect" class="w-full p-2 border rounded hidden mt-2"></select>
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button id="ticketModalCancel" class="btn btn-secondary">Cancel</button>
                <button id="ticketModalSave" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</body>
</html>
